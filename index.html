<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Odyssey 3.14 Innovation Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Epic/classic fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Markdown -> HTML + sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- PDF Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <!-- Mermaid Charts -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --paper: rgba(255, 255, 255, 0.94); /* Slightly more opaque for texture */
      --paper-strong: rgba(255, 255, 255, 0.96);
      --border: rgba(17,24,39,0.12);
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --danger:#b91c1c;

      /* Theme variables randomized in JS */
      --g1x: 20%;
      --g1y: 10%;
      --tintA: rgba(255,237,213,0.95);
      --tintB: rgba(243,244,246,0.80);
      --tintC: rgba(243,244,246,1);
      --bg-img: url("https://commons.wikimedia.org/wiki/Special:FilePath/Ulysses_and_the_Sirens_-_John_William_Waterhouse.jpg?width=2200");
      --bg-op: 0.14;
      --bg-blur: 0.4px;
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      color:var(--ink);
      font-family: "Crimson Pro", ui-serif, Georgia, serif;
      background:
        radial-gradient(1200px 600px at var(--g1x) var(--g1y), var(--tintA), var(--tintB) 55%, var(--tintC)),
        #f3f4f6;
      position:relative;
      overflow-x:hidden;
    }

    /* üé• Feature 4: Ken Burns Effect */
    @keyframes kenburns {
      0% { transform: scale(1.02) translate(0, 0); }
      50% { transform: scale(1.08) translate(-1%, -1%); }
      100% { transform: scale(1.02) translate(0, 0); }
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: var(--bg-img);
      background-size: cover;
      background-position: center;
      opacity: var(--bg-op);
      filter: blur(var(--bg-blur));
      pointer-events:none;
      z-index:-1;
      transform: scale(1.02);
      animation: kenburns 40s ease-in-out infinite alternate; /* The Effect */
    }

    .container{
      max-width: 980px;
      width:100%;
      padding: 28px 18px 44px;
    }

    header{ margin-bottom: 24px; }

    h1{
      font-family: "Cinzel", ui-serif, serif;
      letter-spacing: 0.02em;
      font-weight: 900;
      font-size: clamp(28px, 3.2vw, 44px);
      margin: 0 0 6px 0;
    }

    h2{
      margin:0 0 16px 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 18px;
    }

    .small{
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }

    .row{
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 14px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--paper);
      font-size: 13px;
      font-weight: 700;
      color:#374151;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.8);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    }

    /* ‚õµ Feature 1: Sailing Ship Progress */
    .progress{
      flex: 1;
      min-width: 220px;
      height: 6px; /* Thinner line */
      border-radius: 999px;
      background: rgba(17,24,39,0.1);
      border: none;
      overflow: visible; /* Allow ship to stick out */
      position: relative;
      margin: 0 10px;
    }
    .progress > div{
      height: 100%;
      width: 0%;
      background: var(--accent); /* Sea color */
      border-radius: 999px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    /* The Ship */
    .progress > div::after {
      content: "‚õµ";
      position: absolute;
      right: -10px; /* Center icon on tip */
      top: -16px;   /* Float above line */
      font-size: 20px;
      filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
      transition: transform 0.3s ease;
    }

    /* üìú Feature 3: Parchment Texture */
    .card{
      margin-top: 14px;
      padding: 24px 28px; /* More breathing room */
      border-radius: 18px;
      background-color: var(--paper-strong);
      /* Subtle noise pattern */
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
      border: 1px solid var(--border);
      box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.05), 
        0 10px 15px -3px rgba(0, 0, 0, 0.05),
        inset 0 0 40px rgba(234, 179, 8, 0.05); /* Very subtle gold tint */
      
      /* Base state for transition */
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94), transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
    }
    
    /* Cinematic Transitions classes */
    .card.hidden-anim { display: none; }
    .card.entering { display: block; opacity: 0; transform: translateY(20px); }
    .card.exiting { opacity: 0; transform: translateY(-20px) scale(0.98); }

    .card h3{
      margin: 0 0 10px 0;
      font-family: "Cinzel", ui-serif, serif;
      letter-spacing: 0.01em;
      font-weight: 800;
      font-size: 20px;
    }

    label{
      display:block;
      margin-top: 14px;
      margin-bottom: 8px;
      font-weight: 800;
      color: #374151;
    }

    input[type="text"], textarea{
      width:100%;
      box-sizing:border-box;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.7);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      font-family: inherit;
      font-size: 16px;
    }
    textarea{ min-height: 140px; resize: vertical; line-height: 1.5; }

    input:focus, textarea:focus{
      background: #fff;
      border-color: rgba(37,99,235,0.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.12);
    }

    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top: 20px;
      align-items:center;
    }

    button{
      padding: 12px 24px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor:pointer;
      box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3), 0 2px 4px -1px rgba(37, 99, 235, 0.1);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.05); box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3); }
    button:active{ transform: translateY(0px); }
    button:disabled{ opacity:0.6; cursor:default; box-shadow:none; }

    .secondary{
      background: rgba(255,255,255,0.6);
      color: var(--ink);
      border: 1px solid var(--border);
      box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      font-weight: 700;
    }
    .secondary:hover { background: rgba(255,255,255,0.9); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }

    .ghost{
      background: transparent;
      color: var(--ink);
      border: 1px dashed rgba(17,24,39,0.3);
      box-shadow: none;
      font-weight: 700;
    }
    
    @keyframes pulse-blue {
      0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); }
      100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
    }
    
    .btn-pulse {
      animation: pulse-blue 2s infinite;
    }

    .error{
      color: var(--danger);
      margin-top: 10px;
      font-weight: 800;
      white-space: pre-wrap;
    }

    .hint{
      color: var(--muted);
      font-size: 14px;
      margin-top: 8px;
      line-height: 1.4;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ===== Vibrant AI Output Styling ===== */
    .ai{
      background: rgba(255,255,255,0.5);
      border: 1px solid rgba(17,24,39,0.08);
      border-radius: 16px;
      padding: 18px;
    }
    .ai h1,.ai h2,.ai h3{
      font-family:"Cinzel",serif;
      margin:18px 0 10px;
      letter-spacing: 0.01em;
      color: #1e3a8a;
    }
    .ai p{ margin:10px 0; line-height: 1.6; }
    .ai ul, .ai ol{ margin:10px 0 10px 24px; line-height: 1.6; }
    .ai li{ margin:6px 0; }
    .ai strong{ color:#0f172a; font-weight:700; }
    .ai blockquote{
      margin:12px 0;
      padding:12px 16px;
      border-left:4px solid rgba(37,99,235,.55);
      background:rgba(255,255,255,.6);
      border-radius:8px;
      font-style: italic;
    }
    .ai table{
      width:100%;
      border-collapse: collapse;
      margin:14px 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,0.12);
      background: rgba(255,255,255,0.6);
    }
    .ai th, .ai td{
      text-align:left;
      padding:12px 14px;
      border-bottom: 1px solid rgba(17,24,39,0.08);
      vertical-align: top;
    }
    .ai th{
      background: rgba(37,99,235,0.08);
      font-weight: 800;
    }

    /* ===== ‚ú® Feature 2: Skeleton Loaders ===== */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .skel-block {
      animation: shimmer 2s infinite linear;
      background: linear-gradient(to right, rgba(255,255,255,0) 4%, rgba(255,255,255,0.5) 25%, rgba(255,255,255,0) 36%);
      background-size: 1000px 100%;
      background-color: rgba(0,0,0,0.05);
      border-radius: 6px;
      margin-bottom: 10px;
    }
    
    .skel-title { height: 28px; width: 60%; margin-bottom: 16px; background-color: rgba(0,0,0,0.08); }
    .skel-line { height: 16px; width: 100%; }
    .skel-line.short { width: 70%; }
    .skel-para { margin-bottom: 20px; }

    /* ===== Auto visuals (‚úÖ ~2x smaller) ===== */
    .imgWrap{
      margin-top: 12px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(17,24,39,0.12);
      background: rgba(255,255,255,0.55);
      max-width: 520px;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .imgWrap img{
      display:block;
      width:100%;
      height:auto;
      max-height: 320px;
      object-fit: cover;
    }
    .imgCap{
      padding:10px 12px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(255,255,255,0.85);
      border-top: 1px solid rgba(17,24,39,0.08);
      backdrop-filter: blur(4px);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Odyssey 3.14 Innovation Wizard</h1>
      <h2>Explore an industry ‚Üí uncover gaps ‚Üí run the 14 Directions ‚Üí output a new business model.</h2>

      <div class="row">
        <span class="badge" id="modelBadge"><span class="dot"></span>Model: (detecting‚Ä¶)</span>
        <!-- ‚õµ Ship Progress Bar -->
        <div class="progress" aria-label="Progress">
          <div id="progressBar"></div>
        </div>
        <span class="badge" id="stepBadge">Step 1/17</span>
      </div>

      <p class="small" id="subline">Start by choosing an industry. You can skip any Direction question.</p>
    </header>

    <!-- Screen 1 -->
    <section class="card screen active" id="screenIndustry">
      <h3>Step 1 ‚Äî Choose an industry</h3>

      <label for="industryInput">What is an industry you are interested in innovating within?</label>
      <input id="industryInput" type="text" placeholder="e.g., ski bindings, fast fashion, coffee shops, private tutoring‚Ä¶" />
      <div class="hint">Be specific if you can (e.g., ‚Äúbudget airlines in Europe‚Äù instead of ‚Äúairlines‚Äù).</div>

      <div class="actions">
        <button id="btnIndustryNext" type="button">Continue</button>
        <button id="refreshModelsBtn" class="secondary" type="button">Re-check model</button>
      </div>

      <div id="errorIndustry" class="error"></div>
    </section>

    <!-- Screen 2 -->
    <section class="card screen" id="screenSummary">
      <h3>Step 2 ‚Äî Current industry snapshot</h3>
      <p class="hint">We‚Äôll summarize the current players‚Äô Value Proposition and Value Architecture (high level, no invented data).</p>

      <div id="summaryImgBlock" class="imgWrap">
        <img id="summaryImg" alt="Industry image" />
        <div class="imgCap" id="summaryImgCap">Visualizing the industry‚Ä¶</div>
      </div>

      <div id="summaryText" class="ai" style="margin-top:12px;"></div>

      <div class="actions">
        <button id="btnSummaryContinue" type="button">Continue</button>
        <button id="btnSummaryBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorSummary" class="error"></div>
    </section>

    <!-- Screen 3 -->
    <section class="card screen" id="screenIdea">
      <h3>Step 3 ‚Äî Your underserved value idea</h3>
      <label for="ideaInput">Do you have any ideas to add value where the market is currently lacking?</label>
      <textarea id="ideaInput" placeholder="e.g., ‚Äòreduce waiting time‚Äô, ‚Äòmore transparency‚Äô, ‚Äòlower total ownership cost‚Äô, ‚Äòbetter accessibility‚Äô‚Ä¶"></textarea>
      <div class="hint">If you‚Äôre unsure, write what frustrates customers or what feels unfair/inefficient today.</div>

      <div class="actions">
        <button id="btnIdeaContinue" type="button">Start the 14 Directions</button>
        <button id="btnIdeaBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorIdea" class="error"></div>
    </section>

    <!-- Screen 4 -->
    <section class="card screen" id="screenDirections">
      <h3 id="directionTitle">Direction 1 of 14</h3>
      <p class="small" id="directionSubtitle">Answer in 2‚Äì6 lines. You can skip.</p>

      <label id="directionLabel" for="directionAnswer">Question</label>
      
      <!-- New Toolbar for AI Assistance -->
      <div style="display:flex; justify-content:flex-end; margin-bottom:6px;">
        <button id="btnInspire" type="button" class="secondary btn-pulse" style="font-size:12px; padding:6px 12px; background:rgba(255,255,255,0.7);">‚ú® Inspire Me</button>
      </div>

      <textarea id="directionAnswer" placeholder="Type your answer (or leave blank and click Skip)‚Ä¶"></textarea>
      
      <!-- Container for AI suggestions -->
      <div id="aiSuggestions" class="ai" style="display:none; margin-top:10px; font-size:14px; background:var(--tintA);"></div>
      
      <div class="hint" id="directionHint"></div>

      <div class="actions">
        <button id="btnDirNext" type="button">Next</button>
        <button id="btnDirSkip" class="secondary" type="button">Skip</button>
        <button id="btnDirBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorDir" class="error"></div>
    </section>

    <!-- Screen 5 -->
    <section class="card screen" id="screenOutput">
      <h3>Step 17 ‚Äî Your new business model (Odyssey 3.14)</h3>

      <div id="finalImgBlock" class="imgWrap">
        <img id="finalImg" alt="Industry image" />
        <div class="imgCap" id="finalImgCap">Visualizing your concept‚Ä¶</div>
      </div>

      <div id="finalOutput" class="ai" style="margin-top:12px;"></div>

      <!-- Mermaid Chart Container -->
      <div id="mermaidChart" class="ai" style="margin-top:12px; overflow-x:auto; display:none;"></div>

      <div class="actions">
        <button id="btnExportPDF" class="secondary" type="button">Download PDF</button>
        <button id="btnExportMD" class="secondary" type="button">Download Report (.md)</button>
        <button id="btnExportIMG" class="secondary" type="button">Download Image</button>
        <button id="btnRestart" class="ghost" type="button">Restart (Clear Data)</button>
        <button id="btnOutputBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorOutput" class="error"></div>
    </section>

    <!-- Debug -->
    <section id="debug" class="card" style="display:none; margin-top:14px;">
      <h3>Debug</h3>
      <pre id="debugText"></pre>
    </section>
  </div>

  <script>
    /* ============================================================
       ‚úÖ CONFIG (NO API KEY IN BROWSER)
       ============================================================ */
    const GEMINI_PROXY_URL = "https://314.andrew-albert96.workers.dev"; // keep this
    const PROXY_BASE = GEMINI_PROXY_URL.replace(/\/+$/, "") + "/v1beta";

    // Initialize Mermaid
    mermaid.initialize({ startOnLoad: false, theme: 'default' });

    /* ============================================================
       üîä AUDIO ENGINE (Synthesized Sound FX)
       ============================================================ */
    const AudioEngine = {
        ctx: null,
        
        init: function() {
            if (!this.ctx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) this.ctx = new AudioContext();
            }
            if (this.ctx && this.ctx.state === 'suspended') {
                this.ctx.resume();
            }
        },

        playClick: function() {
            if (!this.ctx) this.init();
            if (!this.ctx) return;
            
            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            // Wood block / tactile click sound
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, t);
            osc.frequency.exponentialRampToValueAtTime(400, t + 0.05);
            
            gain.gain.setValueAtTime(0.3, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.05);
            
            osc.start(t);
            osc.stop(t + 0.05);
        },

        playQuill: function() {
            // Very subtle ticking for "writing"
            if (!this.ctx) return;
            // Rate limit ticks to avoid machine gun sound
            if (Math.random() > 0.3) return;

            const t = this.ctx.currentTime;
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(1200 + Math.random() * 400, t); // varied pitch
            
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.exponentialRampToValueAtTime(0.001, t + 0.03);
            
            osc.start(t);
            osc.stop(t + 0.03);
        },

        playSuccess: function() {
            if (!this.ctx) this.init();
            if (!this.ctx) return;

            const t = this.ctx.currentTime;
            // Magical chime (major chord arpeggio)
            const notes = [523.25, 659.25, 783.99, 1046.50]; // C, E, G, C
            
            notes.forEach((freq, i) => {
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                
                osc.type = 'sine';
                osc.frequency.value = freq;
                
                osc.connect(gain);
                gain.connect(this.ctx.destination);
                
                // Staggered start
                const start = t + (i * 0.1);
                gain.gain.setValueAtTime(0, start);
                gain.gain.linearRampToValueAtTime(0.1, start + 0.05);
                gain.gain.exponentialRampToValueAtTime(0.001, start + 1.5);
                
                osc.start(start);
                osc.stop(start + 1.5);
            });
        }
    };

    // Initialize audio on first click anywhere
    document.addEventListener('click', () => {
        AudioEngine.init();
        AudioEngine.playClick();
    }, { once: true });

    /* ===== OPTION C: HARDCODED ODYSSEY KNOWLEDGE ===== */
    const ODYSSEY_KNOWLEDGE_HARDCODED = `An In-Depth Guide to the Odyssey 3.14 Business Model Innovatio...is a baseline expectation, the competitive frontier has shifte
[NOTE: Full document text is embedded below exactly as extracted from your DOCX.]

An In-Depth Guide to the Odyssey 3.14 Business Model Innovation Framework
The Odyssey 3.14 Framework is a structured method for designing and innovating business models. It emphasizes three pillars: Value Proposition, Value Architecture, and Contributions, and it uses 14 strategic ‚ÄúDirections‚Äù to explore innovation opportunities. Rather than focusing solely on profitability, Odyssey 3.14 expands the analysis to include environmental and societal impacts as well.
This guide outlines the full method, explains the three pillars, and details each of the 14 Directions with examples and diagnostic questions.

1. Core Philosophy
Odyssey 3.14 assumes that business model innovation is not simply about adding features or technology. Instead, innovation occurs when a firm rethinks:
‚Ä¢ Who it serves (clients/users/stakeholders)
‚Ä¢ What value it delivers (functional, emotional, and symbolic)
‚Ä¢ How value is created and delivered (value chain and network)
‚Ä¢ How value is captured and shared (financial, environmental, societal)
The framework encourages rigorous thinking, testing assumptions, and mapping trade-offs.

2. The Three Pillars
2.1 Value Proposition (VP)
The Value Proposition answers:
‚Ä¢ What do we offer? (product/service/experience)
‚Ä¢ To whom? (target client segments and users)
‚Ä¢ At what price? (pricing logic, unit of value, and willingness to pay)
A strong VP is not a slogan. It is a concrete promise tied to a specific segment and pricing logic.

2.2 Value Architecture (VA)
Value Architecture explains how the business produces and delivers the VP. It includes:
‚Ä¢ Value Chain: the sequence of activities from sourcing inputs to delivering and servicing the offer
‚Ä¢ Value Network: partners and stakeholders that enable the chain (suppliers, distributors, complementors, regulators, communities)
‚Ä¢ Strategic Resources & Competencies: key assets, capabilities, and know-how required to make the model work
The VA must be coherent with the VP: if the VP promises speed, the VA must be designed for speed.

2.3 Contributions (Expanded Profit Equation)
Odyssey 3.14 expands beyond profit:
‚Ä¢ Financial Contribution: revenues, costs, capital employed, risk profile
‚Ä¢ Environmental Contribution: impacts across the life cycle, waste, emissions, resource scarcity
‚Ä¢ Societal Contribution: jobs, skills, health, equity, wellbeing, trust, cultural impacts
A business model is ‚Äúbetter‚Äù when it improves contributions without hiding trade-offs.

3. Reference Offer ‚Üí New Business Model
Odyssey begins with a ‚ÄúReference Offer‚Äù: the dominant industry logic today. You map the current VP/VA/Contributions, then apply the Directions to find leverage points. The output is one coherent New Business Model, not a list of ideas.

4. The 14 Directions (with intent)
Direction 1 ‚Äî Reduce customer overall costs
Goal: reduce total cost of ownership (not only price)
Look at: purchase price, time cost, switching cost, maintenance, risk.
Examples: subscription models, pooled ownership, pay-per-use.

Direction 2 ‚Äî Reduce customer hassles
Goal: eliminate friction and pain points in the experience.
Look at: waiting, uncertainty, paperwork, setup, returns, customer support.
Examples: concierge onboarding, instant replacement, guided setup.

Direction 3 ‚Äî Find non-customers
Goal: expand market by serving those excluded or uninterested.
Look at: affordability barriers, access barriers, distrust, complexity, stigma.
Examples: ‚Äúlite‚Äù versions, community distribution, simplified choices.

Direction 4 ‚Äî Add functionality or emotion
Goal: increase value by adding features and/or emotional benefits.
Look at: convenience, reliability, status, belonging, safety, delight.
Examples: personalization, community identity, premium assurance.

Direction 5 ‚Äî Explore other segments or industries
Goal: borrow proven patterns from elsewhere.
Look at: analog industries with different norms (e.g., SaaS, hospitality, gaming).
Examples: memberships, bundling, marketplaces, self-service.

Direction 6 ‚Äî Introduce other stakeholders
Goal: create multi-sided value by involving others.
Look at: employers, insurers, governments, communities, experts.
Examples: employer-paid wellness, insurer-funded prevention, community co-ops.

Direction 7 ‚Äî Modify the revenue stream
Goal: change who pays, when, and for what unit.
Look at: subscriptions, usage-based, outcome-based, freemium, bundling.
Examples: ‚Äúper result‚Äù, ‚Äúper hour saved‚Äù, dynamic pricing.

Direction 8 ‚Äî Introduce a technology
Goal: use tech to enable a new model (not just optimize).
Look at: automation, AI, IoT, automation, apps, blockchain, AR/VR, platforms, data-driven personalization.
Examples: predictive maintenance, AI guidance, sensor-based billing.

Direction 9 ‚Äî Modify steps in the value chain
Goal: redesign a step to improve speed/quality/cost.
Look at: sourcing, production, delivery, service, returns, onboarding.
Examples: local micro-fulfillment, modular assembly, remote service.

Direction 10 ‚Äî Eliminate or add steps
Goal: remove wasteful steps or add steps that create trust/value.
Look at: unnecessary intermediaries, redundant approvals, missing verification.
Examples: remove brokers, add authentication, add training.

Direction 11 ‚Äî Identify new inputs
Goal: change inputs (materials, data, skills) to unlock value.
Look at: recycled materials, open data, community skills, alternative sourcing.
Examples: circular inputs, user-generated data, local crafts.

Direction 12 ‚Äî Associate with competitors/clients/suppliers
Goal: cooperate to create value (co-opetition).
Look at: shared infrastructure, joint purchasing, shared standards.
Examples: shared logistics, shared repair networks.

Direction 13 ‚Äî Identify complementors
Goal: integrate complements before/during/after use.
Look at: installation, financing, insurance, training, resale.
Examples: bundled insurance, embedded financing, aftercare.

Direction 14 ‚Äî Leverage strategic resources
Goal: reuse underutilized assets/capabilities differently.
Look at: brand, data, locations, community, expertise.
Examples: turn stores into service hubs, monetize data ethically, community programs.

5. Coherence & Testing
Every proposed model must be coherent:
‚Ä¢ VP fits the chosen segment and pricing logic
‚Ä¢ VA supports the VP promise
‚Ä¢ Contributions are explicit, including trade-offs
The framework emphasizes experiments: test assumptions quickly with small prototypes.

6. Deliverable Checklist (what outputs should include)
A complete Odyssey 3.14 output includes:
‚Ä¢ Reference offer snapshot (VP/VA/Contributions)
‚Ä¢ New business model (VP/VA/Contributions)
‚Ä¢ Revenue logic, cost drivers, capital intensity (high level)
‚Ä¢ Environmental and societal impacts + mitigations
‚Ä¢ 5 concrete experiments to run next week
‚Ä¢ One key trade-off and how you handle it
`;

    /* ===== Background image reliability fix (preload + fallback) ===== */
    function preloadImage(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(url);
        img.onerror = () => reject(new Error("Failed to load: " + url));
        img.src = url;
      });
    }

    async function setBackgroundWithFallback(urls) {
      const root = document.documentElement;
      for (const u of urls) {
        try {
          await preloadImage(u);
          root.style.setProperty("--bg-img", `url("${u}")`);
          return;
        } catch {}
      }
      root.style.setProperty(
        "--bg-img",
        `url("https://upload.wikimedia.org/wikipedia/commons/2/2e/Ulysses_and_the_Sirens_-_John_William_Waterhouse.jpg")`
      );
    }

    function applyRandomTheme() {
      const root = document.documentElement;

      const gx = Math.floor(8 + Math.random() * 45) + "%";
      const gy = Math.floor(6 + Math.random() * 30) + "%";
      root.style.setProperty("--g1x", gx);
      root.style.setProperty("--g1y", gy);

      const palettes = [
        { a:"rgba(255,237,213,0.95)", b:"rgba(243,244,246,0.82)", c:"rgba(243,244,246,1)" },
        { a:"rgba(224,242,254,0.85)", b:"rgba(243,244,246,0.86)", c:"rgba(243,244,246,1)" },
        { a:"rgba(254,243,199,0.92)", b:"rgba(243,244,246,0.84)", c:"rgba(243,244,246,1)" },
        { a:"rgba(255,228,230,0.80)", b:"rgba(243,244,246,0.88)", c:"rgba(243,244,246,1)" },
        { a:"rgba(220,252,231,0.75)", b:"rgba(243,244,246,0.88)", c:"rgba(243,244,246,1)" },
      ];
      const p = palettes[Math.floor(Math.random() * palettes.length)];
      root.style.setProperty("--tintA", p.a);
      root.style.setProperty("--tintB", p.b);
      root.style.setProperty("--tintC", p.c);

      const overlays = [
        "https://commons.wikimedia.org/wiki/Special:FilePath/OdysseySuitors.png?width=2200",
        "https://commons.wikimedia.org/wiki/Special:FilePath/Odysseus_Returns.jpg?width=2200",
        "https://commons.wikimedia.org/wiki/Special:FilePath/Odysseus_by_Guerin.jpg?width=2200",
        "https://commons.wikimedia.org/wiki/Special:FilePath/Ulysses_and_the_Sirens_-_John_William_Waterhouse.jpg?width=2200",
        "https://commons.wikimedia.org/wiki/Special:FilePath/Alessandro_Allori_-_Odysseus_questions_the_seer_Tiresias.jpg?width=2200",
        "https://commons.wikimedia.org/wiki/Special:FilePath/Odysseus_recognises_Achilles_amongst_the_daughters_of_Lycomedes,_by_Louis_Gauffier.jpg?width=2200",
        "https://commons.wikimedia.org/wiki/Special:FilePath/Tapestry_with_Odysseus_on_a_hunt_by_Brussels_workshop,_17th_century_PD-art_-old,_Olesko_Castle,_possibly_from_John_III_Sobieski%27s_collection.jpg?width=2200"
      ];

      const shuffled = overlays.slice().sort(() => Math.random() - 0.5);
      setBackgroundWithFallback(shuffled);

      const op = (0.10 + Math.random() * 0.08).toFixed(2);
      root.style.setProperty("--bg-op", op);
      root.style.setProperty("--bg-blur", (0.2 + Math.random() * 0.6).toFixed(1) + "px");
    }

    function prettyLoadingSvgDataUri(title, subtitle) {
      const safe = (s) => (s || "").replace(/[<>&"]/g, "");
      const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900" viewBox="0 0 1600 900">
        <defs>
          <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#fde68a"/>
            <stop offset="0.45" stop-color="#e0e7ff"/>
            <stop offset="1" stop-color="#dcfce7"/>
          </linearGradient>
          <filter id="grain">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/>
            <feColorMatrix type="matrix" values="
              1 0 0 0 0
              0 1 0 0 0
              0 0 1 0 0
              0 0 0 .12 0"/>
          </filter>
        </defs>
        <rect width="1600" height="900" fill="url(#bg)"/>
        <rect width="1600" height="900" filter="url(#grain)" opacity="0.35"/>
        <text x="90" y="180" font-family="Cinzel, serif" font-size="64" font-weight="900" fill="#111827">${safe(title)}</text>
        <text x="92" y="240" font-family="Crimson Pro, serif" font-size="30" fill="rgba(17,24,39,.75)">${safe(subtitle)}</text>
        <text x="92" y="295" font-family="Crimson Pro, serif" font-size="22" fill="rgba(17,24,39,.60)">Finding a fun, relevant image‚Ä¶</text>
        <path d="M120 720 C 360 560, 520 820, 760 670 S 1200 560, 1460 700" fill="none" stroke="rgba(37,99,235,.25)" stroke-width="14"/>
        <circle cx="300" cy="650" r="36" fill="rgba(37,99,235,.18)" stroke="rgba(17,24,39,.14)" stroke-width="2"/>
        <circle cx="800" cy="670" r="36" fill="rgba(37,99,235,.18)" stroke="rgba(17,24,39,.14)" stroke-width="2"/>
        <circle cx="1260" cy="690" r="36" fill="rgba(37,99,235,.18)" stroke="rgba(17,24,39,.14)" stroke-width="2"/>
      </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
    }

    async function fetchWikipediaThumb(query) {
      const q = encodeURIComponent(query);
      const url =
        `https://en.wikipedia.org/w/api.php?action=query&generator=search&gsrsearch=${q}` +
        `&gsrlimit=6&prop=pageimages|info&inprop=url&pithumbsize=900&format=json&origin=*`;

      const res = await fetch(url);
      if (!res.ok) throw new Error("Wikipedia image search failed.");
      const data = await res.json();

      const pages = data?.query?.pages ? Object.values(data.query.pages) : [];
      const withThumb = pages.filter(p => p?.thumbnail?.source);
      if (!withThumb.length) return null;

      withThumb.sort((a, b) => {
        const aw = a.thumbnail?.width || 0, ah = a.thumbnail?.height || 0;
        const bw = b.thumbnail?.width || 0, bh = b.thumbnail?.height || 0;
        return (bw * bh) - (aw * ah);
      });

      return {
        src: withThumb[0].thumbnail.source,
        pageUrl: withThumb[0].fullurl || "",
        title: withThumb[0].title || query
      };
    }

    function unsplashFallback(query) {
      const q = encodeURIComponent(query.replace(/[^\w\s-]/g, "").trim());
      return `https://source.unsplash.com/900x500/?${q}`;
    }

    async function setIndustryImageEverywhere(industry) {
      const loading = prettyLoadingSvgDataUri(industry, "Loading an industry image‚Ä¶");
      summaryImg.src = loading;
      finalImg.src = loading;

      summaryImgCap.textContent = `Finding a fun image for: ${industry}`;
      finalImgCap.textContent = `Finding a fun image for: ${industry}`;

      try {
        const tries = [
          industry,
          `${industry} product`,
          `${industry} equipment`,
          `${industry} tool`,
          `${industry} device`,
          `${industry} machine`
        ];

        let picked = null;
        for (const t of tries) {
          picked = await fetchWikipediaThumb(t);
          if (picked?.src) break;
        }

        const src = picked?.src || unsplashFallback(industry);

        summaryImg.src = src;
        finalImg.src = src;

        const cap = picked?.pageUrl
          ? `Image: ${picked.title} (Wikipedia/Wikimedia)`
          : `Image: ${industry} (Unsplash fallback)`;

        summaryImgCap.textContent = cap;
        finalImgCap.textContent = cap;

        state.finalImgUrl = src;
      } catch {
        const src = unsplashFallback(industry);
        summaryImg.src = src;
        finalImg.src = src;
        summaryImgCap.textContent = `Image: ${industry} (fallback)`;
        finalImgCap.textContent = `Image: ${industry} (fallback)`;
        state.finalImgUrl = src;
      }
    }

    /* ===== SYSTEM CONTEXT ===== */
    const SYSTEM_CONTEXT = `
Role: You are an expert consultant and pedagogical guide in the Odyssey 3.14 business model innovation framework.
Your goal is to help students invent new business models with rigor and specificity.

Core pillars (always keep these coherent):
1) Value Proposition (VP): Who are the clients / users? What do we offer? At what price & pricing logic?
2) Value Architecture (VA): How is value created & delivered? (value chain, network/partners, resources, competencies)
3) Contributions (expanded profit equation): Financial + Environmental + Societal outcomes, trade-offs, risks.

Process:
- Start from the "Reference Offer" / current industry logic.
- Diagnose VP/VA/Contributions.
- Use the 14 Directions to generate structured shifts.
- Output one coherent New Business Model + next experiments.

Use crisp Markdown. Avoid invented market numbers; label assumptions.
    `.trim();

    function clampText(s, maxChars) {
      const t = (s || "").trim();
      if (t.length <= maxChars) return t;
      return t.slice(0, maxChars) + "\n\n[TRUNCATED FOR LENGTH]";
    }

    function buildKnowledgeBlock() {
      const k = clampText(state.odysseyKnowledge || "", 12000);
      return k ? k : "None provided.";
    }

    /* ===== MODEL AUTO-DETECT (REAL v1beta call via Worker) ===== */
    let SELECTED_MODEL = null;

    const modelBadge = document.getElementById("modelBadge");
    const refreshModelsBtn = document.getElementById("refreshModelsBtn");
    const debug = document.getElementById("debug");
    const debugText = document.getElementById("debugText");

    function setModelBadge(html) {
      modelBadge.innerHTML = `<span class="dot"></span>${html}`;
    }
    function showDebug(obj) {
      debug.style.display = "block";
      debugText.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
    function hideDebug() {
      debug.style.display = "none";
      debugText.textContent = "";
    }

    function pickBestTextModel(models) {
      const usable = (models || []).filter(m =>
        Array.isArray(m.supportedGenerationMethods) &&
        m.supportedGenerationMethods.includes("generateContent") &&
        typeof m.name === "string"
      );
      if (usable.length === 0) return null;

      const score = (name) => {
        const n = name.toLowerCase();
        if (n.includes("2.5") && n.includes("flash")) return 500;
        if (n.includes("flash")) return 400;
        if (n.includes("pro")) return 300;
        return 200;
      };

      usable.sort((a, b) => score(b.name) - score(a.name));
      return usable[0].name;
    }

    async function detectModel() {
      hideDebug();
      setModelBadge("Model: (detecting‚Ä¶)");

      try {
        const res = await fetch(`${PROXY_BASE}/models`);
        const text = await res.text();

        if (!res.ok) {
          // Fallback: still let the app run with a default model name
          SELECTED_MODEL = "models/gemini-1.5-flash";
          setModelBadge(`Model: <strong>${SELECTED_MODEL}</strong> ¬∑ <span style="opacity:.85">fallback</span>`);
          showDebug(`Model list failed (using fallback model).\n\n${text}`);
          return;
        }

        const data = JSON.parse(text);
        SELECTED_MODEL = pickBestTextModel(data.models || []) || "models/gemini-1.5-flash";
        setModelBadge(`Model: <strong>${SELECTED_MODEL}</strong> ¬∑ <span style="opacity:.85">Visuals: ‚úÖ</span>`);
      } catch (e) {
        // This is almost always CORS/misconfigured worker
        SELECTED_MODEL = null;
        setModelBadge("Model: (error)");
        showDebug(
          "Failed to fetch the Worker.\n" +
          "This is usually CORS (Worker must set Access-Control-Allow-Origin).\n\n" +
          String(e)
        );
      }
    }

    function parseRetrySeconds(rawJsonText) {
      try {
        const j = JSON.parse(rawJsonText);
        const delay = j?.error?.details?.find(d => d["@type"]?.includes("RetryInfo"))?.retryDelay;
        if (!delay) return null;
        const m = String(delay).match(/(\d+)\s*s/i);
        if (m) return parseInt(m[1], 10);
        return null;
      } catch {
        return null;
      }
    }

    function countdownMessage(seconds) {
      return `Rate limited (429). Retrying in ${seconds}s‚Ä¶`;
    }

    /* ===== GEMINI CALL (REAL v1beta call via Worker) ===== */
    async function callGeminiText(promptText, { statusEl } = {}) {
      if (!SELECTED_MODEL) throw new Error("No model selected. Click Re-check model.");

      const url = `${PROXY_BASE}/${SELECTED_MODEL}:generateContent`;

      let attempts = 0;
      const maxAttempts = 6;

      while (attempts < maxAttempts) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });

        const raw = await res.text();

        if (res.ok) {
          const data = JSON.parse(raw);
          return data.candidates?.[0]?.content?.parts?.map(p => p.text || "").join("\n") || "";
        }

        if (res.status === 503) {
          attempts++;
          if (attempts >= maxAttempts) throw new Error("The model is overloaded (503). Try again soon.");
          if (statusEl) statusEl.textContent = `Model overloaded (503). Retrying‚Ä¶ (${attempts}/${maxAttempts})`;
          await new Promise(r => setTimeout(r, 1200 * attempts));
          continue;
        }

        if (res.status === 429) {
          attempts++;
          const retrySec = parseRetrySeconds(raw) ?? Math.min(60, 5 * attempts);
          if (statusEl) {
            let s = retrySec;
            statusEl.textContent = countdownMessage(s);
            await new Promise(resolve => {
              const t = setInterval(() => {
                s--;
                if (s <= 0) {
                  clearInterval(t);
                  resolve();
                } else {
                  statusEl.textContent = countdownMessage(s);
                }
              }, 1000);
            });
          } else {
            await new Promise(r => setTimeout(r, retrySec * 1000));
          }
          continue;
        }

        throw new Error(`Gemini error ${res.status}: ${raw}`);
      }

      throw new Error("Request failed after several retries (rate limit / overload).");
    }

    /* ===== WIZARD STATE ===== */
    const state = {
      industry: "",
      industrySummary: "",
      underservedIdea: "",
      directions: Array.from({length: 14}, () => ""),
      finalModelText: "",
      finalImgUrl: "",
      odysseyKnowledge: ODYSSEY_KNOWLEDGE_HARDCODED
    };

    const TOTAL_STEPS = 17;
    let currentStep = 1;
    let directionIndex = 0;

    const stepBadge = document.getElementById("stepBadge");
    const progressBar = document.getElementById("progressBar");
    const subline = document.getElementById("subline");

    function setStep(n) {
      currentStep = n;
      stepBadge.textContent = `Step ${currentStep}/${TOTAL_STEPS}`;
      progressBar.style.width = `${Math.round(((currentStep - 1) / (TOTAL_STEPS - 1)) * 100)}%`;
    }

    function showScreen(id) {
      const active = document.querySelector(".screen.active");
      const next = document.getElementById(id);
      
      if (!active) {
          // First load
          next.classList.add("active");
          return;
      }
      
      if (active === next) return;

      // Cinematic Exit
      active.classList.add("exiting");
      
      setTimeout(() => {
          active.classList.remove("active", "exiting");
          window.scrollTo({ top: 0, behavior: "smooth" });
          
          // Enter new screen
          next.classList.add("entering"); // set state to translate down/opacity 0
          next.classList.add("active"); // make it block
          
          // Trigger reflow to ensure the entering state is captured before removing it
          void next.offsetWidth;
          
          // Animate in
          next.classList.remove("entering");
      }, 400); // match transition time
    }

    const DIRECTION_QS = [
      { n: 1,  title: "Reduce customer overall costs", q: "How could you lower the customer‚Äôs total cost (price, ownership, time, switching) in this industry?", hint: "Think: cheaper, fewer steps, less waste, lower risk, fewer add-ons." },
      { n: 2,  title: "Reduce customer hassles", q: "What are the biggest pain points/hassles today, and how could you remove them?", hint: "Think: paperwork, waiting, uncertainty, confusing choices, hidden fees." },
      { n: 3,  title: "Find non-customers", q: "Who avoids or ignores this industry‚Äôs offers today‚Äîand why?", hint: "Name 1‚Äì2 groups and their reasons (price, trust, access, stigma, complexity)." },
      { n: 4,  title: "Add functionality or emotion", q: "What could you add (features) or shift (emotional value) to make the offer more compelling?", hint: "Function: speed, quality, reliability. Emotion: status, belonging, safety, fun." },
      { n: 5,  title: "Explore other segments or industries", q: "What idea from another industry could you borrow to improve this one?", hint: "Example patterns: subscriptions, self-service, marketplaces, loyalty, on-demand." },
      { n: 6,  title: "Introduce other stakeholders", q: "Could you connect customers with other parties to create extra value (community, experts, insurers, employers, governments)?", hint: "Think: platforms, ecosystems, shared benefits, referrals." },
      { n: 7,  title: "Modify the revenue stream", q: "How could you change pricing (subscription, usage-based, outcome-based, freemium, bundles)?", hint: "Be specific: who pays, when, and for what unit of value." },
      { n: 8,  title: "Introduce a technology", q: "What technology could change the model (AI, IoT, automation, apps, blockchain, AR/VR)?", hint: "Name the tech and what it replaces or enables." },
      { n: 9,  title: "Modify steps in the value chain", q: "Which step in the value chain could be redesigned for speed/quality/cost?", hint: "Pick one step (acquisition, delivery, service, returns, onboarding)." },
      { n: 10, title: "Eliminate or add steps", q: "What step could you remove as useless‚Äîor add to create value?", hint: "Remove friction; add education, trust, verification, or personalization." },
      { n: 11, title: "Identify new inputs", q: "What new inputs could be used (materials, data, knowledge, skills, local sourcing)?", hint: "Think circular economy, open data, community sourcing, partnerships." },
      { n: 12, title: "Associate with competitors/clients/suppliers", q: "Could you partner with competitors, suppliers, or clients (co-opetition, vertical integration) to unlock value?", hint: "Name a plausible partner type and why they‚Äôd say yes." },
      { n: 13, title: "Identify complementors", q: "What complements could you integrate (before/during/after the main use) to improve the experience?", hint: "Example: setup, financing, insurance, training, resale." },
      { n: 14, title: "Leverage strategic resources", q: "What underused asset/capability could be leveraged differently (brand, data, locations, community, expertise)?", hint: "Name the resource + the new use." },
    ];

    function renderDirection(i) {
      directionIndex = i;
      const d = DIRECTION_QS[i];
      document.getElementById("directionTitle").textContent = `Direction ${d.n} of 14 ‚Äî ${d.title}`;
      document.getElementById("directionLabel").textContent = d.q;
      document.getElementById("directionHint").textContent = d.hint || "";
      document.getElementById("directionAnswer").value = state.directions[i] || "";
      setStep(4 + i);
      subline.textContent = "Answer each Direction (or Skip). After 14, we generate a full Odyssey 3.14 model.";
      
      // Clear old AI suggestions when moving to a new step
      if(typeof clearSuggestions === "function") clearSuggestions();
    }

    /* ‚úçÔ∏è TYPEWRITER EFFECT RENDERER */
    async function typewriterRender(el, markdownText) {
      el.innerHTML = "";
      const chunks = markdownText.split(/(\n\n+)/); // split by paragraph blocks
      
      let fullBuffer = "";
      
      for (const chunk of chunks) {
          fullBuffer += chunk;
          el.innerHTML = DOMPurify.sanitize(marked.parse(fullBuffer));
          
          // üîä Play soft quill sounds during typing
          if (window.AudioEngine) window.AudioEngine.playQuill();
          
          // Approximate "typing" speed: fast for code, readable for text
          const delay = Math.min(chunk.length * 2, 50); 
          await new Promise(r => setTimeout(r, delay));
      }
    }

    function renderMarkdownInto(el, md) {
      // Direct render for non-streamed content (like history)
      const html = DOMPurify.sanitize(marked.parse(md || ""));
      el.innerHTML = html || "<p><em>(No output returned.)</em></p>";
    }
    
    /* ü¶¥ RENDER SKELETON LOADER */
    function renderSkeleton(el) {
        let html = '';
        html += '<div class="skel-block"><div class="skel-title"></div>';
        html += '<div class="skel-line"></div><div class="skel-line"></div><div class="skel-line short"></div><div class="skel-para"></div>';
        html += '<div class="skel-line"></div><div class="skel-line"></div><div class="skel-line"></div><div class="skel-para"></div>';
        html += '<div class="skel-title" style="width:40%"></div>';
        html += '<div class="skel-line"></div><div class="skel-line"></div>';
        html += '</div>';
        el.innerHTML = html;
    }

    /* ===== Screen logic ===== */
    const industryInput = document.getElementById("industryInput");
    const btnIndustryNext = document.getElementById("btnIndustryNext");
    const errorIndustry = document.getElementById("errorIndustry");

    const summaryTextEl = document.getElementById("summaryText");
    const errorSummary = document.getElementById("errorSummary");
    const summaryImg = document.getElementById("summaryImg");
    const summaryImgCap = document.getElementById("summaryImgCap");

    const finalOutputEl = document.getElementById("finalOutput");
    const errorOutput = document.getElementById("errorOutput");
    const finalImg = document.getElementById("finalImg");
    const finalImgCap = document.getElementById("finalImgCap");

    // Helper: add click sound to all buttons
    document.querySelectorAll("button").forEach(b => {
        b.addEventListener("click", () => {
            if(window.AudioEngine) window.AudioEngine.playClick();
        });
    });

    btnIndustryNext.addEventListener("click", async () => {
      errorIndustry.textContent = "";
      const industry = industryInput.value.trim();
      if (!industry) { errorIndustry.textContent = "Please enter an industry."; return; }
      if (!SELECTED_MODEL) { errorIndustry.textContent = "Model not ready. Click ‚ÄúRe-check model‚Äù and try again."; return; }

      state.industry = industry;

      applyRandomTheme();
      setIndustryImageEverywhere(industry);

      setStep(2);
      showScreen("screenSummary");
      subline.textContent = "Generating a high-level snapshot of today‚Äôs industry players (VP + VA)‚Ä¶";

      const knowledge = buildKnowledgeBlock();

      const prompt = `
${SYSTEM_CONTEXT}

Reference notes (use as ground-truth for the Odyssey method; follow its definitions and logic):
${knowledge}

Task:
The student chose this industry: "${industry}".

Write a HIGH-LEVEL snapshot of the main current players in this industry.
Do NOT invent specific company financials. You may name typical player types and if you mention example brands, label them as examples.

IMPORTANT:
- Keep the structure rigorous (VP/VA/Contributions mindset).
- Be concrete and specific.
- Use clean Markdown.

Output format (use EXACT headings):
## 1) Industry map (who plays)
## 2) Typical Value Proposition (VP) today
- **What**
- **To whom**
- **At what price (pricing patterns)
## 3) Typical Value Architecture (VA) today
- **Value chain** (key steps)
- **Value network** (partners/stakeholders)
- **Strategic resources & competencies**
## 4) Current unmet needs / tensions
- 5 bullets

Keep it under ~350 words.
      `.trim();

      // ‚ú® Show Skeleton
      renderSkeleton(summaryTextEl);
      errorSummary.textContent = "";

      try {
        const out = await callGeminiText(prompt, { statusEl: errorSummary });
        state.industrySummary = out;
        
        // Use Typewriter effect here
        await typewriterRender(summaryTextEl, out);
        
        subline.textContent = "Read the snapshot, then continue.";
      } catch (e) {
        summaryTextEl.innerHTML = "";
        errorSummary.textContent = String(e.message || e);
        showDebug(String(e));
      }
    });

    const btnSummaryContinue = document.getElementById("btnSummaryContinue");
    const btnSummaryBack = document.getElementById("btnSummaryBack");

    btnSummaryContinue.addEventListener("click", () => {
      setStep(3);
      showScreen("screenIdea");
      subline.textContent = "Now define the underserved value you want to create.";
    });

    btnSummaryBack.addEventListener("click", () => {
      setStep(1);
      showScreen("screenIndustry");
      subline.textContent = "Start by choosing an industry. You can skip any Direction question.";
    });

    const ideaInput = document.getElementById("ideaInput");
    const btnIdeaContinue = document.getElementById("btnIdeaContinue");
    const btnIdeaBack = document.getElementById("btnIdeaBack");
    const errorIdea = document.getElementById("errorIdea");

    btnIdeaContinue.addEventListener("click", () => {
      errorIdea.textContent = "";
      const idea = ideaInput.value.trim();
      if (!idea) { errorIdea.textContent = "Please write at least one underserved value idea (even a rough one)."; return; }
      state.underservedIdea = idea;
      showScreen("screenDirections");
      renderDirection(0);
    });

    btnIdeaBack.addEventListener("click", () => {
      setStep(2);
      showScreen("screenSummary");
      subline.textContent = "Read the snapshot, then continue.";
    });

    const directionAnswer = document.getElementById("directionAnswer");
    const btnDirNext = document.getElementById("btnDirNext");
    const btnDirSkip = document.getElementById("btnDirSkip");
    const btnDirBack = document.getElementById("btnDirBack");
    const errorDir = document.getElementById("errorDir");

    function saveCurrentDirectionAnswer() {
      state.directions[directionIndex] = directionAnswer.value.trim();
    }

    /* ============================================================
       ‚ú® NEW FEATURE: AI BRAINSTORMING ASSISTANT
       ============================================================ */
    const btnInspire = document.getElementById("btnInspire");
    const aiSuggestions = document.getElementById("aiSuggestions");

    btnInspire.addEventListener("click", async () => {
      // 1. UI State: Loading
      btnInspire.disabled = true;
      btnInspire.textContent = "Thinking...";
      aiSuggestions.style.display = "block";
      renderSkeleton(aiSuggestions);

      // 2. Context
      const currentDir = DIRECTION_QS[directionIndex];
      const industry = state.industry;
      
      // 3. Prompt
      const prompt = `
Context: The user is innovating in the "${industry}" industry using the Odyssey 3.14 framework.
Current Task: Answer Direction #${currentDir.n}: "${currentDir.title}".
Definition: ${currentDir.q}

Goal: Provide 3 distinct, creative, and concrete examples of how players in this industry (or analogies from other industries) could apply this direction.
Keep them brief (1 sentence each). Start each with "‚Ä¢ ".
      `.trim();

      try {
        // 4. Call AI
        const ideas = await callGeminiText(prompt);
        
        // 5. Render clickable ideas
        // We format them so clicking an idea appends it to the textarea
        const lines = ideas.split("\n").filter(line => line.trim().length > 0);
        
        let html = "<strong>Ideas (click to add):</strong><br/>";
        lines.forEach(line => {
           // clean the line
           const cleanLine = line.replace(/^[‚Ä¢\-\*]\s*/, "");
           html += `<div style="cursor:pointer; padding:6px; margin:4px 0; border:1px dashed var(--accent); border-radius:6px;" 
                        onclick="appendIdea('${cleanLine.replace(/'/g, "\\'")}')">
                      ‚ûï ${cleanLine}
                    </div>`;
        });
        
        aiSuggestions.innerHTML = html;

      } catch (e) {
        aiSuggestions.textContent = "Error getting ideas. Try again.";
        console.error(e);
      } finally {
        btnInspire.disabled = false;
        btnInspire.textContent = "‚ú® Inspire Me";
      }
    });

    // Helper to append text to the textarea
    window.appendIdea = function(text) {
      const box = document.getElementById("directionAnswer");
      const sep = box.value.length > 0 ? "\n" : "";
      box.value += sep + text;
      // Visual feedback
      box.style.borderColor = "var(--accent)";
      setTimeout(() => box.style.borderColor = "", 300);
      
      // Trigger save on manual add
      saveProgress();
    };

    // Clear suggestions when moving to next question
    function clearSuggestions() {
      aiSuggestions.style.display = "none";
      aiSuggestions.innerHTML = "";
    }

    /* ============================================================
       END NEW FEATURE
       ============================================================ */

    btnDirNext.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex < 13) { renderDirection(directionIndex + 1); return; }

      setStep(17);
      showScreen("screenOutput");
      subline.textContent = "Generating your new Odyssey 3.14 business model‚Ä¶";
      generateFinalModel();
    });

    btnDirSkip.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex < 13) {
        renderDirection(directionIndex + 1);
      } else {
        setStep(17);
        showScreen("screenOutput");
        subline.textContent = "Generating your new Odyssey 3.14 business model‚Ä¶";
        generateFinalModel();
      }
    });

    btnDirBack.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex > 0) {
        renderDirection(directionIndex - 1);
      } else {
        setStep(3);
        showScreen("screenIdea");
        subline.textContent = "Now define the underserved value you want to create.";
      }
    });

    const btnRestart = document.getElementById("btnRestart");
    const btnOutputBack = document.getElementById("btnOutputBack");
    const btnExportMD = document.getElementById("btnExportMD");
    const btnExportIMG = document.getElementById("btnExportIMG");
    const btnExportPDF = document.getElementById("btnExportPDF");

    /* ============================================================
       üíæ AUTO-SAVE FEATURE
       ============================================================ */
    const STORAGE_KEY = "odyssey_wizard_v1";
    
    function saveProgress() {
      // Also update directions state if we are on that screen
      if (document.getElementById("screenDirections").classList.contains("active")) {
          state.directions[directionIndex] = directionAnswer.value;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    
    function loadProgress() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if(!saved) return false;
      try {
        const parsed = JSON.parse(saved);
        // Merge saved state into current state
        Object.assign(state, parsed);
        
        // Restore inputs
        industryInput.value = state.industry || "";
        ideaInput.value = state.underservedIdea || "";
        
        // Restore images if they exist
        if(state.finalImgUrl) {
            summaryImg.src = state.finalImgUrl;
            finalImg.src = state.finalImgUrl;
        }
        
        if (state.industry) {
            applyRandomTheme();
        }
        return true;
      } catch(e) {
        console.error("Save load failed", e);
        return false;
      }
    }
    
    // Add listeners for auto-save
    industryInput.addEventListener("input", saveProgress);
    ideaInput.addEventListener("input", saveProgress);
    directionAnswer.addEventListener("input", saveProgress);

    btnRestart.addEventListener("click", () => {
      localStorage.removeItem(STORAGE_KEY);
      
      state.industry = "";
      state.industrySummary = "";
      state.underservedIdea = "";
      state.directions = Array.from({length: 14}, () => "");
      state.finalModelText = "";
      state.finalImgUrl = "";

      industryInput.value = "";
      ideaInput.value = "";
      summaryTextEl.innerHTML = "";
      finalOutputEl.innerHTML = "";
      document.getElementById("mermaidChart").innerHTML = "";
      document.getElementById("mermaidChart").style.display = "none";

      summaryImg.src = prettyLoadingSvgDataUri("Industry", "Enter an industry to load an image‚Ä¶");
      summaryImgCap.textContent = "Visualizing the industry‚Ä¶";

      finalImg.src = prettyLoadingSvgDataUri("Business model", "Enter an industry to load an image‚Ä¶");
      finalImgCap.textContent = "Visualizing your concept‚Ä¶";

      errorIndustry.textContent = "";
      errorSummary.textContent = "";
      errorIdea.textContent = "";
      errorDir.textContent = "";
      errorOutput.textContent = "";
      hideDebug();

      applyRandomTheme();

      setStep(1);
      subline.textContent = "Start by choosing an industry. You can skip any Direction question.";
      showScreen("screenIndustry");
    });
    
    /* ============================================================
       üìÑ PDF EXPORT
       ============================================================ */
    btnExportPDF.addEventListener("click", () => {
        const element = document.getElementById("screenOutput");
        const opt = {
          margin:       0.5,
          filename:     `Odyssey_${state.industry.replace(/\s/g,"_")}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2 },
          jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        
        // Hide actions for PDF
        const actions = element.querySelector(".actions");
        const prevDisplay = actions.style.display;
        actions.style.display = "none";
        
        html2pdf().set(opt).from(element).save().then(() => {
            actions.style.display = prevDisplay;
        });
    });

    btnOutputBack.addEventListener("click", () => {
      showScreen("screenDirections");
      renderDirection(13);
    });

    function downloadStringAsFile(content, filename) {
      const blob = new Blob([content], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    btnExportMD.addEventListener("click", () => {
      if (!state.finalModelText) return;
      downloadStringAsFile(state.finalModelText, `Odyssey314_${state.industry.replace(/\s/g,"_")}.md`);
    });

    btnExportIMG.addEventListener("click", async () => {
      const src = state.finalImgUrl;
      if (!src) return;

      try {
        const r = await fetch(src, { mode: "cors" });
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `Odyssey314_Image_${state.industry.replace(/\s/g,"_")}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch {
        window.open(src, "_blank");
      }
    });

    async function generateFinalModel() {
      // ‚ú® Show Skeleton
      renderSkeleton(finalOutputEl);
      document.getElementById("mermaidChart").style.display = "none";
      errorOutput.textContent = "";
      hideDebug();

      finalImgCap.textContent = "Image matches your chosen industry.";

      const answered = DIRECTION_QS.map((d, idx) => {
        const a = (state.directions[idx] || "").trim();
        return `Direction ${d.n} (${d.title}): ${a ? a : "(pass)"}`;
      }).join("\n");

      const knowledge = buildKnowledgeBlock();

      const prompt = `
${SYSTEM_CONTEXT}

Reference notes (use as ground-truth for the Odyssey method; follow its definitions and logic):
${knowledge}

Student project:
Industry: ${state.industry}

Industry snapshot (VP + VA of current players):
${state.industrySummary}

Student underserved value idea:
${state.underservedIdea}

Student answers to the 14 Directions:
${answered}

Task:
Propose ONE coherent "New Business Model" that builds on:
- industry snapshot,
- underserved idea,
- and Direction answers.

IMPORTANT:
- Ensure VP/VA/Contributions are internally consistent.
- Add explicit assumptions where needed.
- Use clean Markdown.
- At the very end of your response, strictly following the text, provide a Mermaid.js flowchart syntax diagram representing the new business model's value architecture. Enclose it in a markdown code block labeled 'mermaid'. The graph should be simple (graph TD). Do not use special characters or parentheses in node IDs. Use quotes for node labels if they contain punctuation.

Output format (use EXACT headings):
## A) New Business Model (Odyssey 3.14)
### 1) Value Proposition (VP)
- **What:**
- **To whom:**
- **At what price (pricing model):**
### 2) Value Architecture (VA)
- **Value chain (key steps):**
- **Value network (key partners/stakeholders):**
- **Strategic resources & competencies:**
### 3) Contributions (Financial + Environmental + Societal)
- **Financial:** revenue logic, major costs, capital intensity; include a simple ROCE-style expression if helpful.
- **Environmental:** main impacts across the chain (scopes / waste / scarce resources) + 2 mitigations.
- **Societal:** employability, quality of life, fair value sharing + 2 mitigations.

## B) Contributions evaluation
Provide a table with columns: Dimension | Score (1‚Äì5) | Why (3 bullets)
Also add: **One key trade-off**

## C) 5 Next experiments
- Five low-cost tests for next week.

## D) Visual Diagram
(Mermaid code block here)

Constraints:
- Concrete, not generic.
- Don‚Äôt invent precise market numbers; label assumptions.
- Keep under ~800 words.
      `.trim();

      try {
        const out = await callGeminiText(prompt, { statusEl: errorOutput });
        
        // Extract Mermaid Block
        const mermaidRegex = /```mermaid([\s\S]*?)```/;
        const match = out.match(mermaidRegex);
        
        if (match) {
            const chartCode = match[1].trim();
            // Remove the mermaid block from the text so it doesn't show as raw markdown
            const cleanText = out.replace(mermaidRegex, "");
            state.finalModelText = cleanText;
            
            // üîä Play Success Chime
            if(window.AudioEngine) window.AudioEngine.playSuccess();

            // Render text with Typewriter effect
            await typewriterRender(finalOutputEl, cleanText);
            
            // Render chart safely
            const chartDiv = document.getElementById("mermaidChart");
            try {
                // Validate syntax first to avoid the "Bomb" icon
                await mermaid.parse(chartCode);
                chartDiv.style.display = "block";
                chartDiv.innerHTML = `<div class="mermaid">${chartCode}</div>`;
                await mermaid.run({ nodes: chartDiv.querySelectorAll(".mermaid") });
            } catch (err) {
                console.warn("Mermaid rendering failed:", err);
                chartDiv.style.display = "none"; 
            }
        } else {
             state.finalModelText = out;
             // üîä Play Success Chime
             if(window.AudioEngine) window.AudioEngine.playSuccess();
             await typewriterRender(finalOutputEl, out);
        }
        
        subline.textContent = "Done. You can go back and tweak answers, then regenerate.";
      } catch (e) {
        finalOutputEl.innerHTML = "";
        errorOutput.textContent = String(e.message || e);
        showDebug(String(e));
      }
    }

    /* ===== INIT ===== */
    applyRandomTheme();
    refreshModelsBtn.addEventListener("click", detectModel);
    detectModel();
    
    // Load saved data
    loadProgress();
    setStep(1);

    summaryImg.src = prettyLoadingSvgDataUri("Industry", "Enter an industry to load an image‚Ä¶");
    finalImg.src = prettyLoadingSvgDataUri("Business model", "Enter an industry to load an image‚Ä¶");
  </script>
</body>
</html>
