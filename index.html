<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Odyssey 3.14 Innovation Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Epic/classic fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Markdown -> HTML + sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --paper: rgba(255, 255, 255, 0.86);
      --paper-strong: rgba(255, 255, 255, 0.92);
      --border: rgba(17,24,39,0.12);
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --danger:#b91c1c;
      --ok:#065f46;
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      color:var(--ink);
      font-family: "Crimson Pro", ui-serif, Georgia, serif;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,237,213,0.95), rgba(243,244,246,0.8) 55%, rgba(243,244,246,1)),
        #f3f4f6;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: url("https://upload.wikimedia.org/wikipedia/commons/8/89/OdysseySuitors.png");
      background-size: cover;
      background-position: center;
      opacity: 0.10;
      filter: blur(0.6px);
      pointer-events:none;
      z-index:-1;
    }

    .container{
      max-width: 980px;
      width:100%;
      padding: 28px 18px 44px;
    }

    header{ margin-bottom: 14px; }

    h1{
      font-family: "Cinzel", ui-serif, serif;
      letter-spacing: 0.02em;
      font-weight: 900;
      font-size: clamp(28px, 3.2vw, 44px);
      margin: 0 0 6px 0;
    }

    h2{
      margin:0 0 10px 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 18px;
    }

    .small{
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--paper);
      font-size: 13px;
      font-weight: 700;
      color:#374151;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.8);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    }

    .progress{
      flex: 1;
      min-width: 220px;
      height: 10px;
      border-radius: 999px;
      background: rgba(17,24,39,0.08);
      border: 1px solid rgba(17,24,39,0.06);
      overflow:hidden;
    }
    .progress > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .25s ease;
    }

    .card{
      margin-top: 14px;
      padding: 16px 18px;
      border-radius: 18px;
      background: var(--paper-strong);
      border: 1px solid var(--border);
      box-shadow: 0 16px 40px rgba(17,24,39,0.10);
    }

    .card h3{
      margin: 0 0 10px 0;
      font-family: "Cinzel", ui-serif, serif;
      letter-spacing: 0.01em;
      font-weight: 800;
      font-size: 18px;
    }

    label{
      display:block;
      margin-top: 10px;
      margin-bottom: 6px;
      font-weight: 800;
    }

    input[type="text"], textarea{
      width:100%;
      box-sizing:border-box;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--paper);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
      font-family: inherit;
      font-size: 16px;
    }
    textarea{ min-height: 130px; resize: vertical; }

    input:focus, textarea:focus{
      border-color: rgba(37,99,235,0.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.14);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
    }

    button{
      padding: 11px 18px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.25);
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(17,24,39,0.12);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    button:active{ transform: translateY(0px); }
    button:disabled{ opacity:0.6; cursor:default; box-shadow:none; }

    .secondary{
      background: rgba(255,255,255,0.55);
      color: var(--ink);
      border: 1px solid var(--border);
      box-shadow: none;
      font-weight: 800;
    }

    .ghost{
      background: transparent;
      color: var(--ink);
      border: 1px dashed rgba(17,24,39,0.25);
      box-shadow: none;
      font-weight: 800;
    }

    .error{
      color: var(--danger);
      margin-top: 10px;
      font-weight: 800;
      white-space: pre-wrap;
    }
    .ok{
      color: var(--ok);
      margin-top: 10px;
      font-weight: 800;
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ===== Vibrant AI Output Styling ===== */
    .ai{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(17,24,39,0.10);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .ai h1,.ai h2,.ai h3{
      font-family:"Cinzel",serif;
      margin:14px 0 8px;
      letter-spacing: 0.01em;
    }
    .ai h1{ font-size: 22px; }
    .ai h2{ font-size: 18px; }
    .ai h3{ font-size: 16px; }
    .ai p{ margin:8px 0; }
    .ai ul, .ai ol{ margin:8px 0 8px 22px; }
    .ai li{ margin:6px 0; }
    .ai strong{ color:#0f172a; }
    .ai code{
      background:rgba(17,24,39,.06);
      padding:2px 6px;
      border-radius:8px;
    }
    .ai blockquote{
      margin:10px 0;
      padding:10px 12px;
      border-left:4px solid rgba(37,99,235,.55);
      background:rgba(255,255,255,.65);
      border-radius:12px;
    }
    .ai table{
      width:100%;
      border-collapse: collapse;
      margin:10px 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,0.12);
      background: rgba(255,255,255,0.6);
    }
    .ai th, .ai td{
      text-align:left;
      padding:10px 10px;
      border-bottom: 1px solid rgba(17,24,39,0.08);
      vertical-align: top;
    }
    .ai th{
      background: rgba(37,99,235,0.08);
      font-weight: 800;
    }

    /* ===== Image block ===== */
    .imgWrap{
      margin-top: 12px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(17,24,39,0.12);
      background: rgba(255,255,255,0.55);
    }
    .imgWrap img{
      display:block;
      width:100%;
      height:auto;
    }
    .imgCap{
      padding:10px 12px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(255,255,255,0.65);
      border-top: 1px solid rgba(17,24,39,0.08);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Odyssey 3.14 Innovation Wizard</h1>
      <h2>Explore an industry → uncover gaps → run the 14 Directions → output a new business model.</h2>

      <div class="row">
        <span class="badge" id="modelBadge"><span class="dot"></span>Model: (detecting…)</span>
        <div class="progress" aria-label="Progress">
          <div id="progressBar"></div>
        </div>
        <span class="badge" id="stepBadge">Step 1/17</span>
      </div>

      <p class="small" id="subline">Start by choosing an industry. You can skip any Direction question.</p>
    </header>

    <!-- Screen 1: Industry -->
    <section class="card screen active" id="screenIndustry">
      <h3>Step 1 — Choose an industry</h3>
      <label for="industryInput">What is an industry you are interested in innovating within?</label>
      <input id="industryInput" type="text" placeholder="e.g., fast fashion, coffee shops, private tutoring, food delivery…" />
      <div class="hint">Be specific if you can (e.g., “budget airlines in Europe” instead of “airlines”).</div>

      <div class="actions">
        <button id="btnIndustryNext" type="button">Continue</button>
        <button id="refreshModelsBtn" class="secondary" type="button">Re-check model</button>
      </div>

      <div id="errorIndustry" class="error"></div>
    </section>

    <!-- Screen 2: Industry summary -->
    <section class="card screen" id="screenSummary">
      <h3>Step 2 — Current industry snapshot</h3>
      <p class="hint">We’ll summarize the current players’ Value Proposition and Value Architecture (high level, no invented data).</p>

      <!-- Styled AI output -->
      <div id="summaryText" class="ai"></div>

      <!-- Optional image -->
      <div class="actions" style="margin-top:12px;">
        <button id="btnSummaryImage" class="secondary" type="button">Generate an industry visual</button>
      </div>
      <div id="summaryImgBlock" class="imgWrap" style="display:none;">
        <img id="summaryImg" alt="Industry visual" />
        <div class="imgCap" id="summaryImgCap"></div>
      </div>

      <div class="actions">
        <button id="btnSummaryContinue" type="button">Continue</button>
        <button id="btnSummaryBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorSummary" class="error"></div>
    </section>

    <!-- Screen 3: Underserved value idea -->
    <section class="card screen" id="screenIdea">
      <h3>Step 3 — Your underserved value idea</h3>
      <label for="ideaInput">List any idea you have to add value that is currently underserved within the market.</label>
      <textarea id="ideaInput" placeholder="e.g., ‘reduce waiting time’, ‘more transparency’, ‘lower total ownership cost’, ‘better accessibility’…"></textarea>
      <div class="hint">If you’re unsure, write what frustrates customers or what feels unfair/inefficient today.</div>

      <div class="actions">
        <button id="btnIdeaContinue" type="button">Start the 14 Directions</button>
        <button id="btnIdeaBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorIdea" class="error"></div>
    </section>

    <!-- Screen 4: Directions (one at a time) -->
    <section class="card screen" id="screenDirections">
      <h3 id="directionTitle">Direction 1 of 14</h3>
      <p class="small" id="directionSubtitle">Answer in 2–6 lines. You can skip.</p>

      <label id="directionLabel" for="directionAnswer">Question</label>
      <textarea id="directionAnswer" placeholder="Type your answer (or leave blank and click Skip)…"></textarea>
      <div class="hint" id="directionHint"></div>

      <div class="actions">
        <button id="btnDirNext" type="button">Next</button>
        <button id="btnDirSkip" class="secondary" type="button">Skip</button>
        <button id="btnDirBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorDir" class="error"></div>
    </section>

    <!-- Screen 5: Final business model output -->
    <section class="card screen" id="screenOutput">
      <h3>Step 17 — Your new business model (Odyssey 3.14)</h3>

      <!-- Styled AI output -->
      <div id="finalOutput" class="ai"></div>

      <!-- Optional concept image -->
      <div class="actions" style="margin-top:12px;">
        <button id="btnFinalImage" class="secondary" type="button">Generate a concept visual</button>
      </div>
      <div id="finalImgBlock" class="imgWrap" style="display:none;">
        <img id="finalImg" alt="Concept visual" />
        <div class="imgCap" id="finalImgCap"></div>
      </div>

      <div class="actions">
        <button id="btnRestart" class="secondary" type="button">Restart</button>
        <button id="btnOutputBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorOutput" class="error"></div>
      <div class="hint" style="margin-top:10px;">Tip: copy/paste this into your assignment report.</div>
    </section>

    <!-- Debug -->
    <section id="debug" class="card" style="display:none; margin-top:14px;">
      <h3>Debug</h3>
      <pre id="debugText"></pre>
    </section>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const GEMINI_API_KEY = "PUT_YOUR_KEY_HERE"; // <-- paste your key here

    /* ===== SYSTEM CONTEXT (your framework) ===== */
    const SYSTEM_CONTEXT = `
Role: You are an expert consultant and pedagogical guide in the Odyssey 3.14 business model innovation framework. Your goal is to help students invent new business models.

Framework pillars:
1) Value Proposition (VP): What / To whom / At what price
2) Value Architecture (VA): value chain, value network, strategic resources & competencies
3) Profit Equation: revenues, costs, capital employed

Contributions to evaluate:
- Financial
- Environmental
- Societal

Process: move from Reference Offer (current state) to New Business Model by exploring 14 Directions.

14 Directions:
1 Reduce customer overall costs
2 Reduce customer hassles
3 Find non-customers
4 Add functionality or emotion
5 Explore other segments or industries
6 Introduce other stakeholders
7 Modify the revenue stream
8 Introduce a technology
9 Modify steps in the value chain
10 Eliminate or add steps
11 Identify new inputs
12 Associate with competitors/clients/suppliers
13 Identify complementors
14 Leverage strategic resources
    `.trim();

    /* ===== MODEL AUTO-DETECT ===== */
    const BASE = "https://generativelanguage.googleapis.com/v1beta";
    let SELECTED_MODEL = null;
    let IMAGE_MODEL = null; // best available image-capable model, if present

    const modelBadge = document.getElementById("modelBadge");
    const refreshModelsBtn = document.getElementById("refreshModelsBtn");
    const debug = document.getElementById("debug");
    const debugText = document.getElementById("debugText");

    function setModelBadge(html) {
      modelBadge.innerHTML = `<span class="dot"></span>${html}`;
    }
    function showDebug(obj) {
      debug.style.display = "block";
      debugText.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
    function hideDebug() {
      debug.style.display = "none";
      debugText.textContent = "";
    }

    function pickBestTextModel(models) {
      const usable = (models || []).filter(m =>
        Array.isArray(m.supportedGenerationMethods) &&
        m.supportedGenerationMethods.includes("generateContent") &&
        typeof m.name === "string"
      );
      if (usable.length === 0) return null;

      const score = (name) => {
        const n = name.toLowerCase();
        if (n.includes("2.5") && n.includes("flash")) return 500;
        if (n.includes("flash")) return 400;
        if (n.includes("pro")) return 300;
        return 200;
      };

      usable.sort((a, b) => score(b.name) - score(a.name));
      return usable[0].name;
    }

    function pickBestImageModel(models) {
      // Heuristic: look for names containing "image" and generateContent support.
      // If your key has an image model, it will appear here.
      const usable = (models || []).filter(m =>
        Array.isArray(m.supportedGenerationMethods) &&
        m.supportedGenerationMethods.includes("generateContent") &&
        typeof m.name === "string" &&
        m.name.toLowerCase().includes("image")
      );
      if (usable.length === 0) return null;

      // Prefer "2.5" + "flash" if present
      const score = (name) => {
        const n = name.toLowerCase();
        if (n.includes("2.5") && n.includes("flash")) return 500;
        if (n.includes("flash")) return 400;
        return 200;
      };
      usable.sort((a, b) => score(b.name) - score(a.name));
      return usable[0].name;
    }

    async function detectModel() {
      hideDebug();
      setModelBadge("Model: (detecting…)");

      if (!GEMINI_API_KEY || GEMINI_API_KEY === "PUT_YOUR_KEY_HERE") {
        setModelBadge("Model: (missing API key)");
        return;
      }

      const url = `${BASE}/models?key=${encodeURIComponent(GEMINI_API_KEY)}`;
      const res = await fetch(url);
      const text = await res.text();

      if (!res.ok) {
        setModelBadge("Model: (not available)");
        showDebug(text);
        SELECTED_MODEL = null;
        IMAGE_MODEL = null;
        return;
      }

      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      SELECTED_MODEL = pickBestTextModel(data.models || []);
      IMAGE_MODEL = pickBestImageModel(data.models || []);

      if (!SELECTED_MODEL) {
        setModelBadge("Model: (none found)");
        showDebug(data);
        return;
      }

      setModelBadge(`Model: <strong>${SELECTED_MODEL}</strong>` + (IMAGE_MODEL ? ` · <span style="opacity:.85">Images: ✅</span>` : ` · <span style="opacity:.85">Images: —</span>`));
    }

    /* ===== WIZARD STATE ===== */
    const state = {
      industry: "",
      industrySummary: "",
      underservedIdea: "",
      directions: Array.from({length: 14}, () => ""),
    };

    const TOTAL_STEPS = 17;
    let currentStep = 1;
    let directionIndex = 0;

    const stepBadge = document.getElementById("stepBadge");
    const progressBar = document.getElementById("progressBar");
    const subline = document.getElementById("subline");

    function setStep(n) {
      currentStep = n;
      stepBadge.textContent = `Step ${currentStep}/${TOTAL_STEPS}`;
      progressBar.style.width = `${Math.round(((currentStep - 1) / (TOTAL_STEPS - 1)) * 100)}%`;
    }

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    /* ===== DIRECTIONS ===== */
    const DIRECTION_QS = [
      { n: 1,  title: "Reduce customer overall costs", q: "How could you lower the customer’s total cost (price, ownership, time, switching) in this industry?", hint: "Think: cheaper, fewer steps, less waste, lower risk, fewer add-ons." },
      { n: 2,  title: "Reduce customer hassles", q: "What are the biggest pain points/hassles today, and how could you remove them?", hint: "Think: paperwork, waiting, uncertainty, confusing choices, hidden fees." },
      { n: 3,  title: "Find non-customers", q: "Who avoids or ignores this industry’s offers today—and why?", hint: "Name 1–2 groups and their reasons (price, trust, access, stigma, complexity)." },
      { n: 4,  title: "Add functionality or emotion", q: "What could you add (features) or shift (emotional value) to make the offer more compelling?", hint: "Function: speed, quality, reliability. Emotion: status, belonging, safety, fun." },
      { n: 5,  title: "Explore other segments or industries", q: "What idea from another industry could you borrow to improve this one?", hint: "Example patterns: subscriptions, self-service, marketplaces, loyalty, on-demand." },
      { n: 6,  title: "Introduce other stakeholders", q: "Could you connect customers with other parties to create extra value (community, experts, insurers, employers, governments)?", hint: "Think: platforms, ecosystems, shared benefits, referrals." },
      { n: 7,  title: "Modify the revenue stream", q: "How could you change pricing (subscription, usage-based, outcome-based, freemium, bundles)?", hint: "Be specific: who pays, when, and for what unit of value." },
      { n: 8,  title: "Introduce a technology", q: "What technology could change the model (AI, IoT, automation, apps, blockchain, AR/VR)?", hint: "Name the tech and what it replaces or enables." },
      { n: 9,  title: "Modify steps in the value chain", q: "Which step in the value chain could be redesigned for speed/quality/cost?", hint: "Pick one step (acquisition, delivery, service, returns, onboarding)." },
      { n: 10, title: "Eliminate or add steps", q: "What step could you remove as useless—or add to create value?", hint: "Remove friction; add education, trust, verification, or personalization." },
      { n: 11, title: "Identify new inputs", q: "What new inputs could be used (materials, data, knowledge, skills, local sourcing)?", hint: "Think circular economy, open data, community sourcing, partnerships." },
      { n: 12, title: "Associate with competitors/clients/suppliers", q: "Could you partner with competitors, suppliers, or clients (co-opetition, vertical integration) to unlock value?", hint: "Name a plausible partner type and why they’d say yes." },
      { n: 13, title: "Identify complementors", q: "What complements could you integrate (before/during/after the main use) to improve the experience?", hint: "Example: setup, financing, insurance, training, aftercare, resale." },
      { n: 14, title: "Leverage strategic resources", q: "What underused asset/capability could be leveraged differently (brand, data, locations, community, expertise)?", hint: "Name the resource + the new use." },
    ];

    function renderDirection(i) {
      directionIndex = i;
      const d = DIRECTION_QS[i];
      document.getElementById("directionTitle").textContent = `Direction ${d.n} of 14 — ${d.title}`;
      document.getElementById("directionLabel").textContent = d.q;
      document.getElementById("directionHint").textContent = d.hint || "";
      document.getElementById("directionAnswer").value = state.directions[i] || "";
      setStep(4 + i);
      subline.textContent = "Answer each Direction (or Skip). After 14, we generate a full Odyssey 3.14 model.";
    }

    /* ===== Markdown render helper ===== */
    function renderMarkdownInto(el, md) {
      const html = DOMPurify.sanitize(marked.parse(md || ""));
      el.innerHTML = html || "<p><em>(No output returned.)</em></p>";
    }

    /* ===== AI CALL (text) with retry on 503 ===== */
    async function callGeminiText(promptText) {
      if (!SELECTED_MODEL) throw new Error("No model selected. Click Re-check model.");

      const url = `${BASE}/${SELECTED_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;
      let attempts = 0;
      const maxAttempts = 3;

      while (attempts < maxAttempts) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: promptText }] }]
          })
        });

        const raw = await res.text();

        if (res.ok) {
          const data = JSON.parse(raw);
          return data.candidates?.[0]?.content?.parts?.map(p => p.text || "").join("\n") || "";
        }

        if (res.status === 503) {
          attempts++;
          if (attempts >= maxAttempts) {
            throw new Error("The model is overloaded (503). Try again in 30–60 seconds.");
          }
          await new Promise(r => setTimeout(r, 1200 * attempts));
          continue;
        }

        throw new Error(`Gemini error ${res.status}: ${raw}`);
      }

      throw new Error("Unexpected error.");
    }

    /* ===== AI CALL (image) ===== */
    async function callGeminiImage(imagePrompt) {
      if (!IMAGE_MODEL) throw new Error("No image model is available for this API key.");

      const url = `${BASE}/${IMAGE_MODEL}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;
      let attempts = 0;
      const maxAttempts = 3;

      while (attempts < maxAttempts) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: imagePrompt }] }]
          })
        });

        const raw = await res.text();

        if (res.ok) {
          const data = JSON.parse(raw);
          const parts = data.candidates?.[0]?.content?.parts || [];
          // Look for inlineData with image
          for (const p of parts) {
            if (p.inlineData && p.inlineData.data && p.inlineData.mimeType) {
              const mime = p.inlineData.mimeType;
              const b64 = p.inlineData.data;
              return { mime, b64 };
            }
          }
          throw new Error("Image model responded but no inline image data was returned.");
        }

        if (res.status === 503) {
          attempts++;
          if (attempts >= maxAttempts) throw new Error("Image model overloaded (503). Try again in 30–60 seconds.");
          await new Promise(r => setTimeout(r, 1200 * attempts));
          continue;
        }

        throw new Error(`Gemini image error ${res.status}: ${raw}`);
      }

      throw new Error("Unexpected image error.");
    }

    /* ===== SCREEN LOGIC ===== */
    const industryInput = document.getElementById("industryInput");
    const btnIndustryNext = document.getElementById("btnIndustryNext");
    const errorIndustry = document.getElementById("errorIndustry");

    const summaryTextEl = document.getElementById("summaryText");
    const errorSummary = document.getElementById("errorSummary");
    const btnSummaryImage = document.getElementById("btnSummaryImage");
    const summaryImgBlock = document.getElementById("summaryImgBlock");
    const summaryImg = document.getElementById("summaryImg");
    const summaryImgCap = document.getElementById("summaryImgCap");

    btnIndustryNext.addEventListener("click", async () => {
      errorIndustry.textContent = "";
      const industry = industryInput.value.trim();
      if (!industry) { errorIndustry.textContent = "Please enter an industry."; return; }
      if (!SELECTED_MODEL) { errorIndustry.textContent = "Model not ready. Click “Re-check model” and try again."; return; }

      state.industry = industry;
      setStep(2);
      showScreen("screenSummary");
      subline.textContent = "Generating a high-level snapshot of today’s industry players (VP + VA)…";

      summaryImgBlock.style.display = "none";
      summaryImg.src = "";
      summaryImgCap.textContent = "";

      const prompt = `
${SYSTEM_CONTEXT}

Task:
The student chose this industry: "${industry}".

Write a HIGH-LEVEL snapshot of the main current players in this industry.
Do NOT invent specific company financials. You may name typical player types and if you mention example brands, label them as examples.

IMPORTANT: Format your answer as clean Markdown with headings, bullet lists, and a small table if useful.

Output format (use EXACT headings):
## 1) Industry map (who plays)
## 2) Typical Value Proposition (VP) today
- **What**
- **To whom**
- **At what price** (pricing patterns)
## 3) Typical Value Architecture (VA) today
- **Value chain** (key steps)
- **Value network** (partners/stakeholders)
- **Strategic resources & competencies**
## 4) Current unmet needs / tensions
- 5 bullets

Keep it under ~350 words. Concrete and structured. Add 1–2 emojis max if it helps readability.
      `.trim();

      renderMarkdownInto(summaryTextEl, "_Generating…_");
      errorSummary.textContent = "";

      try {
        const out = await callGeminiText(prompt);
        state.industrySummary = out;
        renderMarkdownInto(summaryTextEl, out);
        subline.textContent = "Read the snapshot, then continue.";
      } catch (e) {
        summaryTextEl.innerHTML = "";
        errorSummary.textContent = String(e.message || e);
        showDebug(String(e));
      }
    });

    // Image for industry snapshot
    btnSummaryImage.addEventListener("click", async () => {
      errorSummary.textContent = "";
      if (!state.industry) { errorSummary.textContent = "Enter an industry first."; return; }
      if (!IMAGE_MODEL) {
        errorSummary.textContent = "No image model is available for this API key (text features still work).";
        return;
      }

      btnSummaryImage.disabled = true;
      btnSummaryImage.textContent = "Generating visual…";

      try {
        const imgPrompt = `
Create a single, high-quality illustrative image for a student project.
Theme: "${state.industry}" industry.
Style: modern infographic + subtle parchment/epic vibe, clean composition, no text-heavy labels.
Include: 1–2 simple icons that hint at value chain + customers (very minimal).
Avoid: logos, brand names, copyrighted characters, and excessive text.
        `.trim();

        const { mime, b64 } = await callGeminiImage(imgPrompt);
        summaryImg.src = `data:${mime};base64,${b64}`;
        summaryImgCap.textContent = `AI-generated visual for: ${state.industry}`;
        summaryImgBlock.style.display = "block";
      } catch (e) {
        errorSummary.textContent = String(e.message || e);
      } finally {
        btnSummaryImage.disabled = false;
        btnSummaryImage.textContent = "Generate an industry visual";
      }
    });

    // Screen 2 nav
    const btnSummaryContinue = document.getElementById("btnSummaryContinue");
    const btnSummaryBack = document.getElementById("btnSummaryBack");

    btnSummaryContinue.addEventListener("click", () => {
      setStep(3);
      showScreen("screenIdea");
      subline.textContent = "Now define the underserved value you want to create.";
    });

    btnSummaryBack.addEventListener("click", () => {
      setStep(1);
      showScreen("screenIndustry");
      subline.textContent = "Start by choosing an industry. You can skip any Direction question.";
    });

    // Screen 3
    const ideaInput = document.getElementById("ideaInput");
    const btnIdeaContinue = document.getElementById("btnIdeaContinue");
    const btnIdeaBack = document.getElementById("btnIdeaBack");
    const errorIdea = document.getElementById("errorIdea");

    btnIdeaContinue.addEventListener("click", () => {
      errorIdea.textContent = "";
      const idea = ideaInput.value.trim();
      if (!idea) { errorIdea.textContent = "Please write at least one underserved value idea (even a rough one)."; return; }
      state.underservedIdea = idea;
      showScreen("screenDirections");
      renderDirection(0);
    });

    btnIdeaBack.addEventListener("click", () => {
      setStep(2);
      showScreen("screenSummary");
      subline.textContent = "Read the snapshot, then continue.";
    });

    // Screen 4 directions
    const directionAnswer = document.getElementById("directionAnswer");
    const btnDirNext = document.getElementById("btnDirNext");
    const btnDirSkip = document.getElementById("btnDirSkip");
    const btnDirBack = document.getElementById("btnDirBack");
    const errorDir = document.getElementById("errorDir");

    function saveCurrentDirectionAnswer() {
      state.directions[directionIndex] = directionAnswer.value.trim();
    }

    btnDirNext.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex < 13) { renderDirection(directionIndex + 1); return; }

      setStep(17);
      showScreen("screenOutput");
      subline.textContent = "Generating your new Odyssey 3.14 business model…";
      generateFinalModel();
    });

    btnDirSkip.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex < 13) {
        renderDirection(directionIndex + 1);
      } else {
        setStep(17);
        showScreen("screenOutput");
        subline.textContent = "Generating your new Odyssey 3.14 business model…";
        generateFinalModel();
      }
    });

    btnDirBack.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex > 0) {
        renderDirection(directionIndex - 1);
      } else {
        setStep(3);
        showScreen("screenIdea");
        subline.textContent = "Now define the underserved value you want to create.";
      }
    });

    // Screen 5 output
    const finalOutputEl = document.getElementById("finalOutput");
    const errorOutput = document.getElementById("errorOutput");
    const btnRestart = document.getElementById("btnRestart");
    const btnOutputBack = document.getElementById("btnOutputBack");

    const btnFinalImage = document.getElementById("btnFinalImage");
    const finalImgBlock = document.getElementById("finalImgBlock");
    const finalImg = document.getElementById("finalImg");
    const finalImgCap = document.getElementById("finalImgCap");

    btnRestart.addEventListener("click", () => {
      state.industry = "";
      state.industrySummary = "";
      state.underservedIdea = "";
      state.directions = Array.from({length: 14}, () => "");

      industryInput.value = "";
      ideaInput.value = "";

      summaryTextEl.innerHTML = "";
      finalOutputEl.innerHTML = "";

      summaryImgBlock.style.display = "none";
      finalImgBlock.style.display = "none";
      summaryImg.src = "";
      finalImg.src = "";

      errorIndustry.textContent = "";
      errorSummary.textContent = "";
      errorIdea.textContent = "";
      errorDir.textContent = "";
      errorOutput.textContent = "";
      hideDebug();

      setStep(1);
      subline.textContent = "Start by choosing an industry. You can skip any Direction question.";
      showScreen("screenIndustry");
    });

    btnOutputBack.addEventListener("click", () => {
      showScreen("screenDirections");
      renderDirection(13);
    });

    async function generateFinalModel() {
      renderMarkdownInto(finalOutputEl, "_Generating…_");
      errorOutput.textContent = "";
      hideDebug();

      finalImgBlock.style.display = "none";
      finalImg.src = "";
      finalImgCap.textContent = "";

      const answered = DIRECTION_QS.map((d, idx) => {
        const a = (state.directions[idx] || "").trim();
        return `Direction ${d.n} (${d.title}): ${a ? a : "(pass)"}`;
      }).join("\n");

      const prompt = `
${SYSTEM_CONTEXT}

Student project:
Industry: ${state.industry}

Industry snapshot (VP + VA of current players):
${state.industrySummary}

Student underserved value idea:
${state.underservedIdea}

Student answers to the 14 Directions:
${answered}

Task:
Propose ONE coherent "New Business Model" that builds on:
- industry snapshot,
- underserved idea,
- and Direction answers.

IMPORTANT: Format your answer as clean Markdown with headings, bullet lists, and a small score table for Contributions.

Output format (use EXACT headings):
## A) New Business Model (Odyssey 3.14)
### 1) Value Proposition (VP)
- **What:**
- **To whom:**
- **At what price (pricing model):**
### 2) Value Architecture (VA)
- **Value chain (key steps):**
- **Value network (key partners/stakeholders):**
- **Strategic resources & competencies:**
### 3) Profit Equation
- **Revenue:**
- **Costs:**
- **Capital employed:**

## B) Contributions evaluation
Provide a table with columns: Dimension | Score (1–5) | Why (3 bullets)
Also add: **One key trade-off**

## C) 5 Next experiments
- Five low-cost tests for next week.

Constraints:
- Concrete, not generic.
- Don’t invent precise market numbers; label assumptions.
- Keep under ~700 words.
      `.trim();

      try {
        const out = await callGeminiText(prompt);
        renderMarkdownInto(finalOutputEl, out);
        subline.textContent = "Done. You can go back and tweak answers, then regenerate.";
      } catch (e) {
        finalOutputEl.innerHTML = "";
        errorOutput.textContent = String(e.message || e);
        showDebug(String(e));
      }
    }

    // Concept image generation
    btnFinalImage.addEventListener("click", async () => {
      errorOutput.textContent = "";
      if (!state.industry) { errorOutput.textContent = "Missing industry."; return; }
      if (!IMAGE_MODEL) {
        errorOutput.textContent = "No image model is available for this API key (text features still work).";
        return;
      }

      btnFinalImage.disabled = true;
      btnFinalImage.textContent = "Generating visual…";

      try {
        const conceptPrompt = `
Create a single, high-quality concept illustration for a new business model in the "${state.industry}" industry.
Core underserved value idea: "${state.underservedIdea}"

Style: clean modern product concept art + subtle epic/parchment vibe. Cinematic lighting, simple composition.
Include: a central “hero” object/service scene plus small hints of value chain (e.g., icons or minimal elements).
Avoid: logos, brand names, and lots of text.
        `.trim();

        const { mime, b64 } = await callGeminiImage(conceptPrompt);
        finalImg.src = `data:${mime};base64,${b64}`;
        finalImgCap.textContent = `AI-generated concept visual for the new business model idea`;
        finalImgBlock.style.display = "block";
      } catch (e) {
        errorOutput.textContent = String(e.message || e);
      } finally {
        btnFinalImage.disabled = false;
        btnFinalImage.textContent = "Generate a concept visual";
      }
    });

    /* ===== INIT ===== */
    refreshModelsBtn.addEventListener("click", detectModel);
    detectModel();
    setStep(1);
  </script>
</body>
</html>
