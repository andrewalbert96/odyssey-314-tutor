<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Odyssey 3.14 Innovation Wizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Epic/classic fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700;900&family=Crimson+Pro:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Markdown -> HTML + sanitization -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <style>
    :root{
      --ink:#111827;
      --muted:#6b7280;
      --paper: rgba(255, 255, 255, 0.86);
      --paper-strong: rgba(255, 255, 255, 0.92);
      --border: rgba(17,24,39,0.12);
      --accent:#2563eb;
      --accent2:#1d4ed8;
      --danger:#b91c1c;

      /* Theme variables randomized in JS */
      --g1x: 20%;
      --g1y: 10%;
      --tintA: rgba(255,237,213,0.95);
      --tintB: rgba(243,244,246,0.80);
      --tintC: rgba(243,244,246,1);
      --bg-img: url("https://upload.wikimedia.org/wikipedia/commons/8/89/OdysseySuitors.png");
      --bg-op: 0.10;
      --bg-blur: 0.6px;
    }

    body{
      margin:0;
      min-height:100vh;
      display:flex;
      justify-content:center;
      color:var(--ink);
      font-family: "Crimson Pro", ui-serif, Georgia, serif;
      background:
        radial-gradient(1200px 600px at var(--g1x) var(--g1y), var(--tintA), var(--tintB) 55%, var(--tintC)),
        #f3f4f6;
      position:relative;
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: var(--bg-img);
      background-size: cover;
      background-position: center;
      opacity: var(--bg-op);
      filter: blur(var(--bg-blur));
      pointer-events:none;
      z-index:-1;
      transform: scale(1.02);
    }

    .container{
      max-width: 980px;
      width:100%;
      padding: 28px 18px 44px;
    }

    header{ margin-bottom: 14px; }

    h1{
      font-family: "Cinzel", ui-serif, serif;
      letter-spacing: 0.02em;
      font-weight: 900;
      font-size: clamp(28px, 3.2vw, 44px);
      margin: 0 0 6px 0;
    }

    h2{
      margin:0 0 10px 0;
      color: var(--muted);
      font-weight: 700;
      font-size: 18px;
    }

    .small{
      color: var(--muted);
      font-size: 14px;
      margin: 0;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 10px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: var(--paper);
      font-size: 13px;
      font-weight: 700;
      color:#374151;
    }

    .dot{
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(37,99,235,0.8);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    }

    .progress{
      flex: 1;
      min-width: 220px;
      height: 10px;
      border-radius: 999px;
      background: rgba(17,24,39,0.08);
      border: 1px solid rgba(17,24,39,0.06);
      overflow:hidden;
    }
    .progress > div{
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      transition: width .25s ease;
    }

    .card{
      margin-top: 14px;
      padding: 16px 18px;
      border-radius: 18px;
      background: var(--paper-strong);
      border: 1px solid var(--border);
      box-shadow: 0 16px 40px rgba(17,24,39,0.10);
    }

    .card h3{
      margin: 0 0 10px 0;
      font-family: "Cinzel", ui-serif, serif;
      letter-spacing: 0.01em;
      font-weight: 800;
      font-size: 18px;
    }

    label{
      display:block;
      margin-top: 10px;
      margin-bottom: 6px;
      font-weight: 800;
    }

    input[type="text"], textarea{
      width:100%;
      box-sizing:border-box;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--paper);
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease;
      font-family: inherit;
      font-size: 16px;
    }
    textarea{ min-height: 130px; resize: vertical; }

    input:focus, textarea:focus{
      border-color: rgba(37,99,235,0.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,0.14);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 12px;
      align-items:center;
    }

    button{
      padding: 11px 18px;
      border-radius: 999px;
      border: 1px solid rgba(37,99,235,0.25);
      background: linear-gradient(180deg, var(--accent), var(--accent2));
      color:white;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(17,24,39,0.12);
      transition: transform .08s ease, box-shadow .2s ease, filter .2s ease;
    }
    button:hover{ transform: translateY(-1px); filter: brightness(1.02); }
    button:active{ transform: translateY(0px); }
    button:disabled{ opacity:0.6; cursor:default; box-shadow:none; }

    .secondary{
      background: rgba(255,255,255,0.55);
      color: var(--ink);
      border: 1px solid var(--border);
      box-shadow: none;
      font-weight: 800;
    }

    .ghost{
      background: transparent;
      color: var(--ink);
      border: 1px dashed rgba(17,24,39,0.25);
      box-shadow: none;
      font-weight: 800;
    }

    .error{
      color: var(--danger);
      margin-top: 10px;
      font-weight: 800;
      white-space: pre-wrap;
    }

    .hint{
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    .screen{ display:none; }
    .screen.active{ display:block; }

    /* ===== Vibrant AI Output Styling ===== */
    .ai{
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(17,24,39,0.10);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .ai h1,.ai h2,.ai h3{
      font-family:"Cinzel",serif;
      margin:14px 0 8px;
      letter-spacing: 0.01em;
    }
    .ai p{ margin:8px 0; }
    .ai ul, .ai ol{ margin:8px 0 8px 22px; }
    .ai li{ margin:6px 0; }
    .ai strong{ color:#0f172a; }
    .ai blockquote{
      margin:10px 0;
      padding:10px 12px;
      border-left:4px solid rgba(37,99,235,.55);
      background:rgba(255,255,255,.65);
      border-radius:12px;
    }
    .ai table{
      width:100%;
      border-collapse: collapse;
      margin:10px 0;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(17,24,39,0.12);
      background: rgba(255,255,255,0.6);
    }
    .ai th, .ai td{
      text-align:left;
      padding:10px 10px;
      border-bottom: 1px solid rgba(17,24,39,0.08);
      vertical-align: top;
    }
    .ai th{
      background: rgba(37,99,235,0.08);
      font-weight: 800;
    }

    /* ===== Auto visuals ===== */
    .imgWrap{
      margin-top: 12px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(17,24,39,0.12);
      background: rgba(255,255,255,0.55);
    }
    .imgWrap img{
      display:block;
      width:100%;
      height:auto;
    }
    .imgCap{
      padding:10px 12px;
      font-size: 13px;
      color: var(--muted);
      background: rgba(255,255,255,0.65);
      border-top: 1px solid rgba(17,24,39,0.08);
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>Odyssey 3.14 Innovation Wizard</h1>
      <h2>Explore an industry → uncover gaps → run the 14 Directions → output a new business model.</h2>

      <div class="row">
        <span class="badge" id="modelBadge"><span class="dot"></span>Model: (detecting…)</span>
        <div class="progress" aria-label="Progress">
          <div id="progressBar"></div>
        </div>
        <span class="badge" id="stepBadge">Step 1/17</span>
      </div>

      <p class="small" id="subline">Start by choosing an industry. You can skip any Direction question.</p>
    </header>

    <!-- Screen 1 -->
    <section class="card screen active" id="screenIndustry">
      <h3>Step 1 — Choose an industry</h3>
      <label for="industryInput">What is an industry you are interested in innovating within?</label>
      <input id="industryInput" type="text" placeholder="e.g., fast fashion, coffee shops, private tutoring, food delivery…" />
      <div class="hint">Be specific if you can (e.g., “budget airlines in Europe” instead of “airlines”).</div>

      <div class="actions">
        <button id="btnIndustryNext" type="button">Continue</button>
        <button id="refreshModelsBtn" class="secondary" type="button">Re-check model</button>
      </div>

      <div id="errorIndustry" class="error"></div>
    </section>

    <!-- Screen 2 -->
    <section class="card screen" id="screenSummary">
      <h3>Step 2 — Current industry snapshot</h3>
      <p class="hint">We’ll summarize the current players’ Value Proposition and Value Architecture (high level, no invented data).</p>

      <!-- Meaningful diagram shown by default -->
      <div id="summaryImgBlock" class="imgWrap">
        <img id="summaryImg" alt="Industry diagram" />
        <div class="imgCap" id="summaryImgCap">Visualizing the industry…</div>
      </div>

      <div id="summaryText" class="ai" style="margin-top:12px;"></div>

      <div class="actions">
        <button id="btnSummaryContinue" type="button">Continue</button>
        <button id="btnSummaryBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorSummary" class="error"></div>
    </section>

    <!-- Screen 3 -->
    <section class="card screen" id="screenIdea">
      <h3>Step 3 — Your underserved value idea</h3>
      <label for="ideaInput">List any idea you have to add value that is currently underserved within the market.</label>
      <textarea id="ideaInput" placeholder="e.g., ‘reduce waiting time’, ‘more transparency’, ‘lower total ownership cost’, ‘better accessibility’…"></textarea>
      <div class="hint">If you’re unsure, write what frustrates customers or what feels unfair/inefficient today.</div>

      <div class="actions">
        <button id="btnIdeaContinue" type="button">Start the 14 Directions</button>
        <button id="btnIdeaBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorIdea" class="error"></div>
    </section>

    <!-- Screen 4 -->
    <section class="card screen" id="screenDirections">
      <h3 id="directionTitle">Direction 1 of 14</h3>
      <p class="small" id="directionSubtitle">Answer in 2–6 lines. You can skip.</p>

      <label id="directionLabel" for="directionAnswer">Question</label>
      <textarea id="directionAnswer" placeholder="Type your answer (or leave blank and click Skip)…"></textarea>
      <div class="hint" id="directionHint"></div>

      <div class="actions">
        <button id="btnDirNext" type="button">Next</button>
        <button id="btnDirSkip" class="secondary" type="button">Skip</button>
        <button id="btnDirBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorDir" class="error"></div>
    </section>

    <!-- Screen 5 -->
    <section class="card screen" id="screenOutput">
      <h3>Step 17 — Your new business model (Odyssey 3.14)</h3>

      <!-- Meaningful diagram shown by default -->
      <div id="finalImgBlock" class="imgWrap">
        <img id="finalImg" alt="Business model diagram" />
        <div class="imgCap" id="finalImgCap">Visualizing your concept…</div>
      </div>

      <div id="finalOutput" class="ai" style="margin-top:12px;"></div>

      <div class="actions">
        <button id="btnExportMD" class="secondary" type="button">Download Report (.md)</button>
        <button id="btnExportSVG" class="secondary" type="button">Download Diagram (.svg)</button>
        <button id="btnRestart" class="ghost" type="button">Restart</button>
        <button id="btnOutputBack" class="ghost" type="button">Back</button>
      </div>

      <div id="errorOutput" class="error"></div>
    </section>

    <!-- Debug -->
    <section id="debug" class="card" style="display:none; margin-top:14px;">
      <h3>Debug</h3>
      <pre id="debugText"></pre>
    </section>
  </div>

  <script>
    /* ===== CONFIG ===== */
    const GEMINI_API_KEY = "AIzaSyBTkMVWxCcZ1OIUUAqxRcHLGTS7EYoEjNU"; // <-- paste your key here

    /* ===== Background randomizer ===== */
    function applyRandomTheme() {
      const root = document.documentElement;

      const gx = Math.floor(10 + Math.random() * 35) + "%";
      const gy = Math.floor(6 + Math.random() * 22) + "%";
      root.style.setProperty("--g1x", gx);
      root.style.setProperty("--g1y", gy);

      const palettes = [
        { a:"rgba(255,237,213,0.95)", b:"rgba(243,244,246,0.82)", c:"rgba(243,244,246,1)" },
        { a:"rgba(224,242,254,0.80)", b:"rgba(243,244,246,0.86)", c:"rgba(243,244,246,1)" },
        { a:"rgba(254,243,199,0.90)", b:"rgba(243,244,246,0.84)", c:"rgba(243,244,246,1)" },
        { a:"rgba(255,228,230,0.75)", b:"rgba(243,244,246,0.88)", c:"rgba(243,244,246,1)" },
      ];
      const p = palettes[Math.floor(Math.random() * palettes.length)];
      root.style.setProperty("--tintA", p.a);
      root.style.setProperty("--tintB", p.b);
      root.style.setProperty("--tintC", p.c);

      const overlays = [
        "https://upload.wikimedia.org/wikipedia/commons/8/89/OdysseySuitors.png",
        "https://upload.wikimedia.org/wikipedia/commons/0/06/Odysseus_Returns.jpg",
        "https://upload.wikimedia.org/wikipedia/commons/6/6f/Odysseus_by_Guerin.jpg",
        "https://upload.wikimedia.org/wikipedia/commons/3/3e/Ulysses_and_the_Sirens_-_John_William_Waterhouse.jpg"
      ];
      const img = overlays[Math.floor(Math.random() * overlays.length)];
      root.style.setProperty("--bg-img", `url("${img}")`);

      const op = (0.08 + Math.random() * 0.06).toFixed(2);
      root.style.setProperty("--bg-op", op);
      root.style.setProperty("--bg-blur", (0.4 + Math.random() * 0.8).toFixed(1) + "px");
    }

    /* ===== Safe fallback SVG (generic) ===== */
    function svgFallbackDataUri(title, subtitle) {
      const safeTitle = (title || "").replace(/[<>&"]/g, "");
      const safeSub = (subtitle || "").replace(/[<>&"]/g, "");
      const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="1400" height="700" viewBox="0 0 1400 700">
  <defs>
    <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#f8e7c7"/>
      <stop offset="1" stop-color="#e6eefc"/>
    </linearGradient>
    <filter id="grain">
      <feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 .10 0"/>
    </filter>
  </defs>
  <rect width="1400" height="700" fill="url(#g)"/>
  <rect width="1400" height="700" filter="url(#grain)" opacity="0.35"/>
  <path d="M120 520 C 320 420, 420 560, 620 470 S 980 420, 1260 510" fill="none" stroke="rgba(37,99,235,.30)" stroke-width="10"/>
  <circle cx="260" cy="470" r="34" fill="rgba(37,99,235,.20)" stroke="rgba(17,24,39,.15)" stroke-width="2"/>
  <circle cx="700" cy="470" r="34" fill="rgba(37,99,235,.20)" stroke="rgba(17,24,39,.15)" stroke-width="2"/>
  <circle cx="1120" cy="500" r="34" fill="rgba(37,99,235,.20)" stroke="rgba(17,24,39,.15)" stroke-width="2"/>
  <text x="90" y="150" font-family="Cinzel, serif" font-size="54" font-weight="800" fill="#111827">${safeTitle}</text>
  <text x="92" y="200" font-family="Crimson Pro, serif" font-size="28" fill="rgba(17,24,39,.75)">${safeSub}</text>
  <text x="92" y="255" font-family="Crimson Pro, serif" font-size="20" fill="rgba(17,24,39,.60)">Generating a meaningful diagram from AI output…</text>
</svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg.trim());
    }

    /* ===== IMPROVED SVG diagram FROM AI TEXT ===== */
    function renderIndustrySvgFromText(title, subtitle, mdText) {
      const text = (mdText || "").replace(/\r/g, "");

      // Helper: flexible search for a line following a key pattern
      function findValue(keyPatterns) {
        for (const pattern of keyPatterns) {
          // Look for: pattern (colon/dash/newline) (content)
          const re = new RegExp(`(?:\\n|^|[*\\-])\\s*${pattern}\\s*[:\\-–]?\\s*(.*)`, "i");
          const m = text.match(re);
          if (m && m[1] && m[1].trim().length > 3) {
            // cleanup leading bold chars if any
            return m[1].trim().replace(/^\*\*|^\*/, "").replace(/\*\*$/, "").trim();
          }
        }
        return "";
      }

      // 1. Extract VP items
      let what = findValue(["what", "offer", "product"]);
      let whom = findValue(["to whom", "target", "customer", "segment"]);
      let price = findValue(["at what price", "price", "pricing", "revenue model"]);

      if (!what) what = "Primary Offer / Service";
      if (!whom) whom = "Target Segment";
      if (!price) price = "Pricing Scheme";

      // 2. Extract Value Chain Steps (List parsing)
      let steps = [];
      // Attempt to find "Value chain" section and grab bullets
      // We look for "Value chain" header, then grab subsequent lines starting with * or -
      const chainMatch = text.match(/(?:value chain|key steps).*?(?:\n|$)([\s\S]*?)(?=\n##|\n\*\*value network|\n\*\*strategic|$)/i);
      
      if (chainMatch && chainMatch[1]) {
        const rawList = chainMatch[1];
        // split by newline, filter for bullets
        steps = rawList.split("\n")
          .map(l => l.trim())
          .filter(l => /^[-*•\d\.]+\s+/.test(l)) // strict bullet check
          .map(l => l.replace(/^[-*•\d\.]+\s+/, "").replace(/\*\*/g, "").trim())
          .filter(Boolean)
          .slice(0, 6); // max 6 steps
      }

      // Fallback if no bullets found
      if (steps.length === 0) steps = ["Design", "Source", "Produce", "Market", "Distribute"];

      const safe = (s) => (s || "").replace(/[<>&"]/g, "");
      const W = 1400, H = 760;

      const card = (x,y,w,h,heading,bodyHtml) => `
        <g>
          <rect x="${x}" y="${y}" rx="18" ry="18" width="${w}" height="${h}"
            fill="rgba(255,255,255,0.78)" stroke="rgba(17,24,39,0.15)" />
          <text x="${x+22}" y="${y+44}" font-size="30" font-weight="800" font-family="Cinzel, serif" fill="#111827">${safe(heading)}</text>
          <foreignObject x="${x+22}" y="${y+62}" width="${w-44}" height="${h-76}">
            <div xmlns="http://www.w3.org/1999/xhtml"
              style="font-family:'Crimson Pro',serif;font-size:22px;line-height:1.25;color:rgba(17,24,39,.82);">
              ${bodyHtml}
            </div>
          </foreignObject>
        </g>
      `;

      // Layout nodes across bottom
      const nodes = steps.map((s,i)=>{
        const x = 140 + i * ((W-280)/Math.max(steps.length-1,1));
        const y = 600;
        return { s, x, y };
      });

      const links = nodes.slice(0,-1).map((_,i)=>{
        const a = nodes[i], b = nodes[i+1];
        return `<path d="M ${a.x} ${a.y} C ${a.x+80} ${a.y-90}, ${b.x-80} ${b.y-90}, ${b.x} ${b.y}"
          fill="none" stroke="rgba(37,99,235,0.38)" stroke-width="10" />`;
      }).join("");

      const nodeDraw = nodes.map(n=>`
        <g>
          <circle cx="${n.x}" cy="${n.y}" r="34" fill="rgba(37,99,235,0.18)" stroke="rgba(17,24,39,0.14)" stroke-width="2"/>
          <text x="${n.x}" y="${n.y+8}" text-anchor="middle"
            font-family="Crimson Pro,serif" font-size="18" font-weight="700" fill="#111827">
            ${safe(n.s).slice(0,18)}
          </text>
        </g>
      `).join("");

      const svg = `
<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}" viewBox="0 0 ${W} ${H}">
  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0" stop-color="#f8e7c7"/>
      <stop offset="1" stop-color="#e6eefc"/>
    </linearGradient>
    <filter id="grain">
      <feTurbulence type="fractalNoise" baseFrequency="0.85" numOctaves="2" stitchTiles="stitch"/>
      <feColorMatrix type="matrix" values="
        1 0 0 0 0
        0 1 0 0 0
        0 0 1 0 0
        0 0 0 .10 0"/>
    </filter>
  </defs>

  <rect width="${W}" height="${H}" fill="url(#bg)"/>
  <rect width="${W}" height="${H}" filter="url(#grain)" opacity="0.35"/>

  <text x="70" y="86" font-family="Cinzel, serif" font-size="52" font-weight="900" fill="#111827">${safe(title)}</text>
  <text x="72" y="124" font-family="Crimson Pro, serif" font-size="24" fill="rgba(17,24,39,.70)">${safe(subtitle)}</text>

  ${card(70,160,420,320,"Value Proposition",
    `<b>What:</b> ${safe(what)}<br/><b>To whom:</b> ${safe(whom)}<br/><b>Price:</b> ${safe(price)}`)}

  ${card(520,160,810,320,"Value Architecture",
    `<b>Value chain (key steps):</b><br/>${steps.map(s=>`• ${safe(s)}`).join("<br/>")}`)}

  <text x="70" y="560" font-family="Cinzel, serif" font-size="28" font-weight="800" fill="#111827">Value chain flow</text>
  ${links}
  ${nodeDraw}
</svg>`.trim();

      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }

    /* ===== SYSTEM CONTEXT ===== */
    const SYSTEM_CONTEXT = `
Role: You are an expert consultant and pedagogical guide in the Odyssey 3.14 business model innovation framework. Your goal is to help students invent new business models.

Framework pillars:
1) Value Proposition (VP): What / To whom / At what price
2) Value Architecture (VA): value chain, value network, strategic resources & competencies
3) Profit Equation: revenues, costs, capital employed

Contributions to evaluate:
- Financial
- Environmental
- Societal

Process: move from Reference Offer (current state) to New Business Model by exploring 14 Directions.

14 Directions:
1 Reduce customer overall costs
2 Reduce customer hassles
3 Find non-customers
4 Add functionality or emotion
5 Explore other segments or industries
6 Introduce other stakeholders
7 Modify the revenue stream
8 Introduce a technology
9 Modify steps in the value chain
10 Eliminate or add steps
11 Identify new inputs
12 Associate with competitors/clients/suppliers
13 Identify complementors
14 Leverage strategic resources
    `.trim();

    /* ===== MODEL AUTO-DETECT ===== */
    const BASE = "https://generativelanguage.googleapis.com/v1beta";
    let SELECTED_MODEL = null;

    const modelBadge = document.getElementById("modelBadge");
    const refreshModelsBtn = document.getElementById("refreshModelsBtn");
    const debug = document.getElementById("debug");
    const debugText = document.getElementById("debugText");

    function setModelBadge(html) {
      modelBadge.innerHTML = `<span class="dot"></span>${html}`;
    }
    function showDebug(obj) {
      debug.style.display = "block";
      debugText.textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }
    function hideDebug() {
      debug.style.display = "none";
      debugText.textContent = "";
    }

    function pickBestTextModel(models) {
      const usable = (models || []).filter(m =>
        Array.isArray(m.supportedGenerationMethods) &&
        m.supportedGenerationMethods.includes("generateContent") &&
        typeof m.name === "string"
      );
      if (usable.length === 0) return null;

      const score = (name) => {
        const n = name.toLowerCase();
        if (n.includes("2.5") && n.includes("flash")) return 500;
        if (n.includes("flash")) return 400;
        if (n.includes("pro")) return 300;
        return 200;
      };

      usable.sort((a, b) => score(b.name) - score(a.name));
      return usable[0].name;
    }

    async function detectModel() {
      hideDebug();
      setModelBadge("Model: (detecting…)");

      // NOTE: We will likely want to change how this key is retrieved
      // if we add a UI input for it.
      let keyToUse = GEMINI_API_KEY; 
      
      if (!keyToUse || keyToUse === "PUT_YOUR_KEY_HERE") {
        setModelBadge("Model: (missing API key)");
        return;
      }

      const url = `${BASE}/models?key=${encodeURIComponent(keyToUse)}`;
      const res = await fetch(url);
      const text = await res.text();

      if (!res.ok) {
        setModelBadge("Model: (not available)");
        showDebug(text);
        SELECTED_MODEL = null;
        return;
      }

      let data;
      try { data = JSON.parse(text); } catch { data = { raw: text }; }

      SELECTED_MODEL = pickBestTextModel(data.models || []);
      if (!SELECTED_MODEL) {
        setModelBadge("Model: (none found)");
        showDebug(data);
        return;
      }

      setModelBadge(`Model: <strong>${SELECTED_MODEL}</strong> · <span style="opacity:.85">Visuals: ✅ (meaningful diagrams)</span>`);
    }

    /* ===== WIZARD STATE ===== */
    const state = {
      industry: "",
      industrySummary: "",
      underservedIdea: "",
      directions: Array.from({length: 14}, () => ""),
      finalModelText: "", // New state to hold text for export
      finalSvgData: "",   // New state to hold svg for export
    };

    const TOTAL_STEPS = 17;
    let currentStep = 1;
    let directionIndex = 0;

    const stepBadge = document.getElementById("stepBadge");
    const progressBar = document.getElementById("progressBar");
    const subline = document.getElementById("subline");

    function setStep(n) {
      currentStep = n;
      stepBadge.textContent = `Step ${currentStep}/${TOTAL_STEPS}`;
      progressBar.style.width = `${Math.round(((currentStep - 1) / (TOTAL_STEPS - 1)) * 100)}%`;
    }

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    const DIRECTION_QS = [
      { n: 1,  title: "Reduce customer overall costs", q: "How could you lower the customer’s total cost (price, ownership, time, switching) in this industry?", hint: "Think: cheaper, fewer steps, less waste, lower risk, fewer add-ons." },
      { n: 2,  title: "Reduce customer hassles", q: "What are the biggest pain points/hassles today, and how could you remove them?", hint: "Think: paperwork, waiting, uncertainty, confusing choices, hidden fees." },
      { n: 3,  title: "Find non-customers", q: "Who avoids or ignores this industry’s offers today—and why?", hint: "Name 1–2 groups and their reasons (price, trust, access, stigma, complexity)." },
      { n: 4,  title: "Add functionality or emotion", q: "What could you add (features) or shift (emotional value) to make the offer more compelling?", hint: "Function: speed, quality, reliability. Emotion: status, belonging, safety, fun." },
      { n: 5,  title: "Explore other segments or industries", q: "What idea from another industry could you borrow to improve this one?", hint: "Example patterns: subscriptions, self-service, marketplaces, loyalty, on-demand." },
      { n: 6,  title: "Introduce other stakeholders", q: "Could you connect customers with other parties to create extra value (community, experts, insurers, employers, governments)?", hint: "Think: platforms, ecosystems, shared benefits, referrals." },
      { n: 7,  title: "Modify the revenue stream", q: "How could you change pricing (subscription, usage-based, outcome-based, freemium, bundles)?", hint: "Be specific: who pays, when, and for what unit of value." },
      { n: 8,  title: "Introduce a technology", q: "What technology could change the model (AI, IoT, automation, apps, blockchain, AR/VR)?", hint: "Name the tech and what it replaces or enables." },
      { n: 9,  title: "Modify steps in the value chain", q: "Which step in the value chain could be redesigned for speed/quality/cost?", hint: "Pick one step (acquisition, delivery, service, returns, onboarding)." },
      { n: 10, title: "Eliminate or add steps", q: "What step could you remove as useless—or add to create value?", hint: "Remove friction; add education, trust, verification, or personalization." },
      { n: 11, title: "Identify new inputs", q: "What new inputs could be used (materials, data, knowledge, skills, local sourcing)?", hint: "Think circular economy, open data, community sourcing, partnerships." },
      { n: 12, title: "Associate with competitors/clients/suppliers", q: "Could you partner with competitors, suppliers, or clients (co-opetition, vertical integration) to unlock value?", hint: "Name a plausible partner type and why they’d say yes." },
      { n: 13, title: "Identify complementors", q: "What complements could you integrate (before/during/after the main use) to improve the experience?", hint: "Example: setup, financing, insurance, training, aftercare, resale." },
      { n: 14, title: "Leverage strategic resources", q: "What underused asset/capability could be leveraged differently (brand, data, locations, community, expertise)?", hint: "Name the resource + the new use." },
    ];

    function renderDirection(i) {
      directionIndex = i;
      const d = DIRECTION_QS[i];
      document.getElementById("directionTitle").textContent = `Direction ${d.n} of 14 — ${d.title}`;
      document.getElementById("directionLabel").textContent = d.q;
      document.getElementById("directionHint").textContent = d.hint || "";
      document.getElementById("directionAnswer").value = state.directions[i] || "";
      setStep(4 + i);
      subline.textContent = "Answer each Direction (or Skip). After 14, we generate a full Odyssey 3.14 model.";
    }

    function renderMarkdownInto(el, md) {
      const html = DOMPurify.sanitize(marked.parse(md || ""));
      el.innerHTML = html || "<p><em>(No output returned.)</em></p>";
    }

    async function callGeminiText(promptText) {
      // Logic will need to access the dynamic key if we add the UI
      let keyToUse = GEMINI_API_KEY;

      if (!SELECTED_MODEL) throw new Error("No model selected. Click Re-check model.");
      const url = `${BASE}/${SELECTED_MODEL}:generateContent?key=${encodeURIComponent(keyToUse)}`;

      let attempts = 0;
      const maxAttempts = 3;

      while (attempts < maxAttempts) {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });

        const raw = await res.text();

        if (res.ok) {
          const data = JSON.parse(raw);
          return data.candidates?.[0]?.content?.parts?.map(p => p.text || "").join("\n") || "";
        }

        if (res.status === 503) {
          attempts++;
          if (attempts >= maxAttempts) throw new Error("The model is overloaded (503). Try again in 30–60 seconds.");
          await new Promise(r => setTimeout(r, 1200 * attempts));
          continue;
        }

        throw new Error(`Gemini error ${res.status}: ${raw}`);
      }

      throw new Error("Unexpected error.");
    }

    /* ===== Screen logic ===== */
    const industryInput = document.getElementById("industryInput");
    const btnIndustryNext = document.getElementById("btnIndustryNext");
    const errorIndustry = document.getElementById("errorIndustry");

    const summaryTextEl = document.getElementById("summaryText");
    const errorSummary = document.getElementById("errorSummary");
    const summaryImg = document.getElementById("summaryImg");
    const summaryImgCap = document.getElementById("summaryImgCap");

    const finalOutputEl = document.getElementById("finalOutput");
    const errorOutput = document.getElementById("errorOutput");
    const finalImg = document.getElementById("finalImg");
    const finalImgCap = document.getElementById("finalImgCap");

    btnIndustryNext.addEventListener("click", async () => {
      errorIndustry.textContent = "";
      const industry = industryInput.value.trim();
      if (!industry) { errorIndustry.textContent = "Please enter an industry."; return; }
      if (!SELECTED_MODEL) { errorIndustry.textContent = "Model not ready. Click “Re-check model” and try again."; return; }

      state.industry = industry;

      // Show a “loading” diagram immediately
      summaryImg.src = svgFallbackDataUri(industry, "Building a VP/VA diagram from the AI snapshot…");
      summaryImgCap.textContent = `Diagram will be generated from the AI snapshot for: ${industry}`;

      setStep(2);
      showScreen("screenSummary");
      subline.textContent = "Generating a high-level snapshot of today’s industry players (VP + VA)…";

      const prompt = `
${SYSTEM_CONTEXT}

Task:
The student chose this industry: "${industry}".

Write a HIGH-LEVEL snapshot of the main current players in this industry.
Do NOT invent specific company financials. You may name typical player types and if you mention example brands, label them as examples.

IMPORTANT: Format your answer as clean Markdown with headings, bullet lists, and a small table if useful.

Output format (use EXACT headings):
## 1) Industry map (who plays)
## 2) Typical Value Proposition (VP) today
- **What**
- **To whom**
- **At what price** (pricing patterns)
## 3) Typical Value Architecture (VA) today
- **Value chain** (key steps)
- **Value network** (partners/stakeholders)
- **Strategic resources & competencies**
## 4) Current unmet needs / tensions
- 5 bullets

Keep it under ~350 words. Concrete and structured. Add 1–2 emojis max if it helps readability.
      `.trim();

      renderMarkdownInto(summaryTextEl, "_Generating…_");
      errorSummary.textContent = "";

      try {
        const out = await callGeminiText(prompt);
        state.industrySummary = out;
        renderMarkdownInto(summaryTextEl, out);
        subline.textContent = "Read the snapshot, then continue.";

        // NOW generate the meaningful diagram from the AI output
        summaryImg.src = renderIndustrySvgFromText(
          state.industry,
          "Industry snapshot diagram (auto-built from the AI text)",
          out
        );
        summaryImgCap.textContent = `Diagram generated from the AI snapshot for: ${state.industry}`;
      } catch (e) {
        summaryTextEl.innerHTML = "";
        errorSummary.textContent = String(e.message || e);
        showDebug(String(e));
      }
    });

    const btnSummaryContinue = document.getElementById("btnSummaryContinue");
    const btnSummaryBack = document.getElementById("btnSummaryBack");

    btnSummaryContinue.addEventListener("click", () => {
      setStep(3);
      showScreen("screenIdea");
      subline.textContent = "Now define the underserved value you want to create.";
    });

    btnSummaryBack.addEventListener("click", () => {
      setStep(1);
      showScreen("screenIndustry");
      subline.textContent = "Start by choosing an industry. You can skip any Direction question.";
    });

    const ideaInput = document.getElementById("ideaInput");
    const btnIdeaContinue = document.getElementById("btnIdeaContinue");
    const btnIdeaBack = document.getElementById("btnIdeaBack");
    const errorIdea = document.getElementById("errorIdea");

    btnIdeaContinue.addEventListener("click", () => {
      errorIdea.textContent = "";
      const idea = ideaInput.value.trim();
      if (!idea) { errorIdea.textContent = "Please write at least one underserved value idea (even a rough one)."; return; }
      state.underservedIdea = idea;
      showScreen("screenDirections");
      renderDirection(0);
    });

    btnIdeaBack.addEventListener("click", () => {
      setStep(2);
      showScreen("screenSummary");
      subline.textContent = "Read the snapshot, then continue.";
    });

    const directionAnswer = document.getElementById("directionAnswer");
    const btnDirNext = document.getElementById("btnDirNext");
    const btnDirSkip = document.getElementById("btnDirSkip");
    const btnDirBack = document.getElementById("btnDirBack");
    const errorDir = document.getElementById("errorDir");

    function saveCurrentDirectionAnswer() {
      state.directions[directionIndex] = directionAnswer.value.trim();
    }

    btnDirNext.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex < 13) { renderDirection(directionIndex + 1); return; }

      setStep(17);
      showScreen("screenOutput");
      subline.textContent = "Generating your new Odyssey 3.14 business model…";
      generateFinalModel();
    });

    btnDirSkip.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex < 13) {
        renderDirection(directionIndex + 1);
      } else {
        setStep(17);
        showScreen("screenOutput");
        subline.textContent = "Generating your new Odyssey 3.14 business model…";
        generateFinalModel();
      }
    });

    btnDirBack.addEventListener("click", () => {
      errorDir.textContent = "";
      saveCurrentDirectionAnswer();

      if (directionIndex > 0) {
        renderDirection(directionIndex - 1);
      } else {
        setStep(3);
        showScreen("screenIdea");
        subline.textContent = "Now define the underserved value you want to create.";
      }
    });

    const btnRestart = document.getElementById("btnRestart");
    const btnOutputBack = document.getElementById("btnOutputBack");
    const btnExportMD = document.getElementById("btnExportMD");
    const btnExportSVG = document.getElementById("btnExportSVG");

    btnRestart.addEventListener("click", () => {
      state.industry = "";
      state.industrySummary = "";
      state.underservedIdea = "";
      state.directions = Array.from({length: 14}, () => "");
      state.finalModelText = "";
      state.finalSvgData = "";

      industryInput.value = "";
      ideaInput.value = "";
      summaryTextEl.innerHTML = "";
      finalOutputEl.innerHTML = "";

      summaryImg.src = svgFallbackDataUri("Industry", "Visual placeholder");
      summaryImgCap.textContent = "Visualizing the industry…";

      finalImg.src = svgFallbackDataUri("Business model", "Visual placeholder");
      finalImgCap.textContent = "Visualizing your concept…";

      errorIndustry.textContent = "";
      errorSummary.textContent = "";
      errorIdea.textContent = "";
      errorDir.textContent = "";
      errorOutput.textContent = "";
      hideDebug();

      setStep(1);
      subline.textContent = "Start by choosing an industry. You can skip any Direction question.";
      showScreen("screenIndustry");
    });

    btnOutputBack.addEventListener("click", () => {
      showScreen("screenDirections");
      renderDirection(13);
    });

    // Helper: Download text as file
    function downloadStringAsFile(content, filename) {
      const blob = new Blob([content], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Helper: Download data URI as image
    function downloadDataUri(uri, filename) {
      const a = document.createElement("a");
      a.href = uri;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    btnExportMD.addEventListener("click", () => {
      if (!state.finalModelText) return;
      downloadStringAsFile(state.finalModelText, `Odyssey314_${state.industry.replace(/\s/g,"_")}.md`);
    });

    btnExportSVG.addEventListener("click", () => {
      if (!state.finalSvgData) return;
      downloadDataUri(state.finalSvgData, `Odyssey314_Diagram_${state.industry.replace(/\s/g,"_")}.svg`);
    });

    async function generateFinalModel() {
      renderMarkdownInto(finalOutputEl, "_Generating…_");
      errorOutput.textContent = "";
      hideDebug();

      // Show “loading” diagram immediately
      finalImg.src = svgFallbackDataUri("New Business Model", "Building a diagram from your generated model…");
      finalImgCap.textContent = "Diagram will be generated from your final AI output.";

      const answered = DIRECTION_QS.map((d, idx) => {
        const a = (state.directions[idx] || "").trim();
        return `Direction ${d.n} (${d.title}): ${a ? a : "(pass)"}`;
      }).join("\n");

      const prompt = `
${SYSTEM_CONTEXT}

Student project:
Industry: ${state.industry}

Industry snapshot (VP + VA of current players):
${state.industrySummary}

Student underserved value idea:
${state.underservedIdea}

Student answers to the 14 Directions:
${answered}

Task:
Propose ONE coherent "New Business Model" that builds on:
- industry snapshot,
- underserved idea,
- and Direction answers.

IMPORTANT: Format your answer as clean Markdown with headings, bullet lists, and a small score table for Contributions.

Output format (use EXACT headings):
## A) New Business Model (Odyssey 3.14)
### 1) Value Proposition (VP)
- **What:**
- **To whom:**
- **At what price (pricing model):**
### 2) Value Architecture (VA)
- **Value chain (key steps):**
- **Value network (key partners/stakeholders):**
- **Strategic resources & competencies:**
### 3) Profit Equation
- **Revenue:**
- **Costs:**
- **Capital employed:**

## B) Contributions evaluation
Provide a table with columns: Dimension | Score (1–5) | Why (3 bullets)
Also add: **One key trade-off**

## C) 5 Next experiments
- Five low-cost tests for next week.

Constraints:
- Concrete, not generic.
- Don’t invent precise market numbers; label assumptions.
- Keep under ~700 words.
      `.trim();

      try {
        const out = await callGeminiText(prompt);
        state.finalModelText = out; // Save for export
        renderMarkdownInto(finalOutputEl, out);
        subline.textContent = "Done. You can go back and tweak answers, then regenerate.";

        // Meaningful diagram from final output text
        const svgData = renderIndustrySvgFromText(
          "New Business Model",
          `Odyssey 3.14 diagram (auto-built from the final AI output)`,
          out
        );
        state.finalSvgData = svgData; // Save for export
        finalImg.src = svgData;
        finalImgCap.textContent = "Diagram generated from your final business model output.";
      } catch (e) {
        finalOutputEl.innerHTML = "";
        errorOutput.textContent = String(e.message || e);
        showDebug(String(e));
      }
    }

    /* ===== INIT ===== */
    applyRandomTheme();
    refreshModelsBtn.addEventListener("click", detectModel);
    detectModel();
    setStep(1);

    // preload placeholders
    summaryImg.src = svgFallbackDataUri("Industry", "Visual placeholder");
    finalImg.src = svgFallbackDataUri("Business model", "Visual placeholder");
  </script>
</body>
</html>
